<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>浅谈spring | Gordo</title><meta name="keywords" content="java,spring,容器"><meta name="author" content="捕猹少年"><meta name="copyright" content="捕猹少年"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言开发工具和环境：使用的开发工具基于Eclipse，创建的简单Maven工程 导入Spring相关的jar包，在maven仓库（https:&#x2F;&#x2F;mvnrepository.com）里找到spring context,选择5.1.10版本,配置到pom.xml中 1234567&lt;dependencies&gt;    &lt;dependency&gt;    &lt;groupId&amp;g">
<meta property="og:type" content="article">
<meta property="og:title" content="浅谈spring">
<meta property="og:url" content="https://gitee.com/zhangyangibm/zhangyangibm.git/2020/12/10/%E6%B5%85%E8%B0%88Spring/index.html">
<meta property="og:site_name" content="Gordo">
<meta property="og:description" content="前言开发工具和环境：使用的开发工具基于Eclipse，创建的简单Maven工程 导入Spring相关的jar包，在maven仓库（https:&#x2F;&#x2F;mvnrepository.com）里找到spring context,选择5.1.10版本,配置到pom.xml中 1234567&lt;dependencies&gt;    &lt;dependency&gt;    &lt;groupId&amp;g">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/zhangyangibm/zhangyangibm.git/img/spring.png">
<meta property="article:published_time" content="2020-12-10T14:47:47.000Z">
<meta property="article:modified_time" content="2022-02-27T08:45:46.175Z">
<meta property="article:author" content="捕猹少年">
<meta property="article:tag" content="java">
<meta property="article:tag" content="spring">
<meta property="article:tag" content="容器">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/zhangyangibm/zhangyangibm.git/img/spring.png"><link rel="shortcut icon" href="/zhangyangibm/img/logo.jpg"><link rel="canonical" href="https://gitee.com/zhangyangibm/zhangyangibm.git/2020/12/10/%E6%B5%85%E8%B0%88Spring/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/zhangyangibm/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/zhangyangibm/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '浅谈spring',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-27 16:45:46'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/zhangyangibm/img/header.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/zhangyangibm/archives/"><div class="headline">文章</div><div class="length-num">14</div></a></div><div class="data-item"><a href="/zhangyangibm/tags/"><div class="headline">标签</div><div class="length-num">30</div></a></div><div class="data-item"><a href="/zhangyangibm/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/zhangyangibm/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/zhangyangibm/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间抽</span></a></div><div class="menus_item"><a class="site-page" href="/zhangyangibm/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/zhangyangibm/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/zhangyangibm/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/zhangyangibm/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/zhangyangibm/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/zhangyangibm/">Gordo</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/zhangyangibm/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/zhangyangibm/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间抽</span></a></div><div class="menus_item"><a class="site-page" href="/zhangyangibm/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/zhangyangibm/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/zhangyangibm/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/zhangyangibm/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/zhangyangibm/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">浅谈spring</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-12-10T14:47:47.000Z" title="发表于 2020-12-10 22:47:47">2020-12-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-02-27T08:45:46.175Z" title="更新于 2022-02-27 16:45:46">2022-02-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/zhangyangibm/categories/%E6%96%87%E7%AB%A0/">文章</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/zhangyangibm/categories/%E6%96%87%E7%AB%A0/%E6%95%99%E7%A8%8B/">教程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="浅谈spring"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><span id="more"></span>

<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>开发工具和环境：使用的开发工具基于Eclipse，创建的简单Maven工程<br><img src="/zhangyangibm/images/20210313/0001.png" alt="Eclipse" title="Eclipse"></p>
<p>导入Spring相关的jar包，在maven仓库（<a target="_blank" rel="noopener" href="https://mvnrepository.com)里找到spring/">https://mvnrepository.com）里找到spring</a> context,选择5.1.10版本,配置到pom.xml中<br><img src="/zhangyangibm/images/20210313/0002.png" alt="Eclipse" title="Eclipse"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样Spring的环境就完成<br><img src="/zhangyangibm/images/20210313/0003.png" alt="Eclipse" title="Eclipse"></p>
<h3 id="1、IOC容器"><a href="#1、IOC容器" class="headerlink" title="1、IOC容器"></a>1、IOC容器</h3><p>在以往的开发模式中，还需要创建一个xml的配置文件，目的是配置bean标签，达到SpringIOC容器自动创建对象的目的，这里使用Person.java为例，内部有两个私有的属性name和age，配置的方式如下：<br><img src="/zhangyangibm/images/20210313/0004.png" alt="Beamxml" title="Beamxml"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">       <span class="comment">//获取到容器对象</span></span><br><span class="line">	<span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line">	<span class="comment">//使用ID获取xml文件中的需要创建的对象</span></span><br><span class="line">	<span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;person&quot;</span>);</span><br><span class="line">	System.out.println(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这样的方式在Spring容器启动的时候Person对象就可以创建完成。类似这样的方式是基于配置文件，实际上为了达到这样的目的我们可以使用另外一种方式，这就是注解。</p>
<h4 id="1-1、创建对象"><a href="#1-1、创建对象" class="headerlink" title="1.1、创建对象"></a>1.1、创建对象</h4><p>首先需要替换Bean.xml配置文件，使用注解 <strong>@Configuration</strong>，@Configuration注解标记在类上，就会对Spring容器声明这是一个配置类，在其内部使用 <strong>@Bean</strong> 注解声明一个控件，并且注册在容器中，逻辑关系具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfig</span> &#123;</span><br><span class="line">    <span class="comment">//给容器中注册一个Bean；类型是Person，id默认是方法名</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">person</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Marry&quot;</span>,<span class="string">&quot;23&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于是使用注解的方式注册的，同样main方法调用启动方法也有一些调整，这次使用的是AnnotationConfigApplicationContext：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;	</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(MainConfig.class);</span><br><span class="line">    <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> applicationContext.getBean(Person.class);</span><br><span class="line">    System.out.println(person);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果证明与之前的xml方式一样的结果<br><img src="/zhangyangibm/images/20210313/0005.png" alt="Beamxml" title="Beamxml"></p>
<p>使用这种方式，也可以设置Bean的id，在默认情况下，Bean的Id就是方法名person，Spring通过 <strong>@Bean</strong> 注解里边的属性可以重新设置id，例如@Bean(“per”)，实现方式如下：<br><img src="/zhangyangibm/images/20210313/0006.png" alt="Beamxml" title="Beamxml"></p>
<h4 id="1-2、包扫描"><a href="#1-2、包扫描" class="headerlink" title="1.2、包扫描"></a>1.2、包扫描</h4><p>包扫描的主要作用是告诉Spring容器，哪些包下的问价可以由Spring负责初始化和管理。<br>通常在配置包扫描时，之前的做法是在配置文件中引入包扫描的包，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 包扫描:只要是标注了@Controller、@Service、@Repository、@Component，注解的组件都会被自动的扫描 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.zhy&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="1-2-1-实现方法"><a href="#1-2-1-实现方法" class="headerlink" title="1.2.1 实现方法"></a>1.2.1 实现方法</h5><p>还有对应注解的替代xml <strong>@ComponentScan</strong><br>在注解中的实现方式，只需要在配置类上加入@ComponentScan注解即可实现，注解中使用value属性，制定需要扫描包,如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(value=&quot;com.zhy&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(&quot;per&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">person1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Marry&quot;</span>,<span class="string">&quot;23&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>传统意义的开发模式中，类的创建会分为控制层Controller，逻辑层Service和Dao层，在各个层级上添加对的注解@Controller、@Service、@Repository，就可在包扫描的之后Spring容器帮助我们建立好相互之间的逻辑关系。<br><img src="/zhangyangibm/images/20210313/0007.png" alt="Beamxml" title="Beamxml"><br>验证：可以查看到所有的组件的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IOCTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;resource&quot;)</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(MainConfig.class);</span><br><span class="line">        String[] methodname = applicationContext.getBeanDefinitionNames();</span><br><span class="line">        <span class="comment">//获取容器类的名字</span></span><br><span class="line">        <span class="keyword">for</span> (String name : methodname) &#123;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/images/20210313/0008.png" alt="Beamxml" title="Beamxml"></p>
<h5 id="1-2-2-过滤"><a href="#1-2-2-过滤" class="headerlink" title="1.2.2 过滤"></a>1.2.2 过滤</h5><ul>
<li>@ComponentScan注解也可以指定扫描的包，其中包括一些属性<br>Filter[] includeFilters() default {};&#x2F;&#x2F;包含哪些扫描的文件<br>Filter[] excludeFilters() default {};&#x2F;&#x2F;排除哪些扫描的文件<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//可以根据条件排除扫描的包：包含组件</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(value=&quot;com.zhy&quot;,includeFilters= &#123;@Filter(type=FilterType.ANNOTATION,classes = &#123;Controller.class&#125;)&#125;,useDefaultFilters = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfig</span> &#123;</span><br><span class="line">    <span class="comment">//给容器中注册一个Bean；类型是Person，id默认是方法名</span></span><br><span class="line">    <span class="meta">@Bean(&quot;per&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">person1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Marry&quot;</span>,<span class="string">&quot;23&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//可以根据条件排除扫描的包：排除组件</span></span><br><span class="line"><span class="meta">@ComponentScan(value=&quot;com.zhy&quot;,excludeFilters= &#123;</span></span><br><span class="line"><span class="meta">@Filter(type=FilterType.ANNOTATION,classes = &#123;Controller.class,Repository.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p>针对与包扫描，jdk1.8也提供了新的玩法 <strong>@ComponentScans</strong> 整个注解可以理解为@ComponentScan的集合版本,在源码的注释中也有如下的说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Container annotation that aggregates several &#123;<span class="doctag">@link</span> ComponentScan&#125; annotations.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Can be used natively, declaring several nested &#123;<span class="doctag">@link</span> ComponentScan&#125; annotations.</span></span><br><span class="line"><span class="comment"> * Can also be used in conjunction with Java 8&#x27;s support for repeatable annotations,</span></span><br><span class="line"><span class="comment"> * where &#123;<span class="doctag">@link</span> ComponentScan&#125; can simply be declared several times on the same method,</span></span><br><span class="line"><span class="comment"> * implicitly generating this container annotation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.3</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ComponentScan</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScans(value = &#123; @ComponentScan(value = &quot;com.zhy&quot;, includeFilters = &#123;</span></span><br><span class="line"><span class="meta">@Filter(type = FilterType.ANNOTATION, classes = &#123; Controller.class &#125;) &#125;, useDefaultFilters = false) &#125;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>除了扫描包以外，也可以实现有条件的过滤，这里列举一个 <strong>@Filter</strong> 注解的例子，还可以包含类型，例如以下将springService类型（类，继承它的子类和现实类等）的组件也包含在容器中使，用 <strong>FilterType.ASSIGNABLE_TYPE</strong> 属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScans(value = &#123; @ComponentScan(value = &quot;com.zhy&quot;, includeFilters = &#123;</span></span><br><span class="line"><span class="meta">@Filter(type = FilterType.ANNOTATION, classes = &#123; Controller.class &#125;),</span></span><br><span class="line"><span class="meta">@Filter(type = FilterType.ASSIGNABLE_TYPE, classes = &#123; springService.class &#125;),</span></span><br><span class="line"><span class="meta">&#125;, useDefaultFilters = false) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;per&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">person1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Marry&quot;</span>, <span class="string">&quot;23&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以通过正则表达式的方式，进行过滤 FilterType.REGEX</p>
</li>
<li><p>自定义过滤 FilterType.CUSTOM<br>依据源码的描述,在实现各个功能之前，需要实现TypeFilter接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Filter candidates using a given custom</span></span><br><span class="line"><span class="comment">* &#123;<span class="doctag">@link</span> org.springframework.core.type.filter.TypeFilter&#125; implementation.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>首先需要自己定一个类MyTypeFilter，实现TypeFilter接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTypeFilter</span> <span class="keyword">implements</span> <span class="title class_">TypeFilter</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 接口实现完成之后会看到一个match的方法，返回值boolean，入参是两个</span></span><br><span class="line"><span class="comment">* metadataReader：读取到当前正在扫描类的信息</span></span><br><span class="line"><span class="comment">* metadataReaderFactory：获取到其他任何类的信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">match</span><span class="params">(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory)</span></span><br><span class="line"><span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//获取当前类注解的信息</span></span><br><span class="line">    <span class="type">AnnotationMetadata</span> <span class="variable">annotationMetadata</span> <span class="operator">=</span> metadataReader.getAnnotationMetadata();</span><br><span class="line">    <span class="comment">//获取当前正在扫描类的类信息（类型和实现接口）</span></span><br><span class="line">    <span class="type">ClassMetadata</span> <span class="variable">classMetadata</span> <span class="operator">=</span> metadataReader.getClassMetadata();</span><br><span class="line">    <span class="comment">//获取当前类资源的信息</span></span><br><span class="line">    <span class="type">Resource</span> <span class="variable">resource</span> <span class="operator">=</span> metadataReader.getResource();</span><br><span class="line">    <span class="type">String</span> <span class="variable">classname</span> <span class="operator">=</span> classMetadata.getClassName();</span><br><span class="line">    System.out.println(<span class="string">&quot;---&gt;&quot;</span>+classname);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个时候在过滤器上可以使用FilterType.CUSTOM，引用我们自己定义的MyTypeFilter.class，实现过滤的控制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScans(value = &#123; @ComponentScan(value = &quot;com.zhy&quot;, includeFilters = &#123;</span></span><br><span class="line"><span class="meta">@Filter(type = FilterType.CUSTOM,classes = &#123;MyTypeFilter.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;, useDefaultFilters = false) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 给容器中注册一个Bean；类型是Person，id是person</span></span><br><span class="line">    <span class="meta">@Bean(&quot;person&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">person1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Marry&quot;</span>, <span class="string">&quot;23&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="1-3-单实例和多实例"><a href="#1-3-单实例和多实例" class="headerlink" title="1.3 单实例和多实例"></a>1.3 单实例和多实例</h4><p>首先观察一个现象<br>重新定义一个配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfig1</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(&quot;per_id&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">person</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Linda&quot;</span>, <span class="string">&quot;25&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>引用测试，在测试类中，我们同时获取两次这个实例<br><img src="/zhangyangibm/images/20210313/0009.png" alt="Beamxml" title="Beamxml"><br>测试结果发现，两次结果是true，说明为同一个实体。说明Spring容器在帮助创建对象的时候，在整个内存环境中只创建了一个对象提供外部调用，也就是单实例。<br>介绍一个注解 <strong>@Scope</strong>，实现单多实例</p>
<ul>
<li>@Scope(“prototype”)多实例 。IOC容器启动的时候并不会创建对象放在容器中，只有当真正的获取的时候才会创建对象，而且多册获取多次调用</li>
<li>@Scope(“singleton”)单实例（默认）。IOC容器启动的时候就会创建好对象放在容器中，因为是单实例的，每次获取都是同一个对象</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfig1</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> ConfigurableBeanFactory#SCOPE_PROTOTYPE //prototype 多实例。</span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> ConfigurableBeanFactory#SCOPE_SINGLETON //singleton 单实例（默认值）</span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> org.springframework.web.context.WebApplicationContext#SCOPE_REQUEST //REQUEST </span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> org.springframework.web.context.WebApplicationContext#SCOPE_SESSION //session</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line">    <span class="meta">@Bean(&quot;per_id&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> Person <span class="title function_">person</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Linda&quot;</span>, <span class="string">&quot;25&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>多实例验证：创建对象的两次不同<br><img src="/zhangyangibm/images/20210313/0010.png" alt="Beamxml" title="Beamxml"></p>
<h4 id="1-4-懒加载"><a href="#1-4-懒加载" class="headerlink" title="1.4 懒加载"></a>1.4 懒加载</h4><p>针对单实例中在容器刚一创建时就会创建对象，有时会造成资源的浪费或占用，优化的方式就是懒加载。<br>在容器启动的时候不创建对象，当第一次使用的时候在正式创建，并进行初始化，这个时候可以使用 <strong>@Lazy</strong> 注解，以下案例：<br>Person对象在Spring容器初始化的时候不会被创建，当第一次被使用的时候，Person对象才会被真正的new出来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfig1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Lazy</span></span><br><span class="line">    <span class="meta">@Bean(&quot;per_id&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">person</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;使用了。。。。。&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Linda&quot;</span>, <span class="string">&quot;25&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当对象Spring容器创建之初：会发现对象没有被创建<br><img src="/zhangyangibm/images/20210313/0011.png" alt="Lazy" title="Lazy"></p>
<p>当对象在第一次使用之后，观察对象被调用，<br><img src="/zhangyangibm/images/20210313/0012.png" alt="Lazy" title="Lazy"></p>
<h4 id="1-5-使用条件判断注册bean-Conditional注解"><a href="#1-5-使用条件判断注册bean-Conditional注解" class="headerlink" title="1.5 使用条件判断注册bean @Conditional注解"></a>1.5 使用条件判断注册bean <strong>@Conditional</strong>注解</h4><p>按照一定的条件进行判断，满足条件给容器中注册Bean。<br>假设一种场景，如果当前的系统是windows，就给容器注册（per_id1）,假设一种场景，如果当前的系统是Linux，就给容器注册（per_id2）<br>查看以下的案例：首先需要定义一个类来实现Condition接口，返回值boolean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断是否MacOS系统  Maconditional和 Winconditional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Maconditional</span> <span class="keyword">implements</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * context：判断条件能使用的环境 metadata：注释信息</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> &#123;</span><br><span class="line">        <span class="comment">// 是否MacOS系统</span></span><br><span class="line">        <span class="comment">// 1、能获取到ioc使用的BeanFactory</span></span><br><span class="line">        <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> context.getBeanFactory();</span><br><span class="line">        <span class="comment">// 2、获取类加载器</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> context.getClassLoader();</span><br><span class="line">        <span class="comment">// 3、获取到环境</span></span><br><span class="line">        <span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> context.getEnvironment();</span><br><span class="line">        <span class="comment">// 4、获取到bean定义的注册类</span></span><br><span class="line">        <span class="type">BeanDefinitionRegistry</span> <span class="variable">registry</span> <span class="operator">=</span> context.getRegistry();</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">property</span> <span class="operator">=</span> environment.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (property.contains(<span class="string">&quot;Mac&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>满足的情况，当Spring容器启动之后，判断当前系统的内核是什么系统，如果是MacOS则@Conditional({Maconditional.class})返回值是true，创建Mayun这个对象，否侧不是MacOS，接口返回值是false，反之创建Wangjin对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断是否MacOS系统</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfig1</span> &#123;</span><br><span class="line">	<span class="meta">@Bean(&quot;per_id1&quot;)</span></span><br><span class="line">	<span class="meta">@Conditional(&#123;Maconditional.class&#125;)</span></span><br><span class="line">	<span class="keyword">public</span> Person <span class="title function_">person1</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Mayun&quot;</span>, <span class="string">&quot;40&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Bean(&quot;per_id2&quot;)</span></span><br><span class="line">	<span class="meta">@Conditional(&#123;Winconditional.class&#125;)</span></span><br><span class="line">	<span class="keyword">public</span> Person <span class="title function_">person2</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Wangjin&quot;</span>, <span class="string">&quot;55&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为本次测试的时候主机系统是MacOs，此时我想验证Windows环境，因此需要手动配置环境虚拟机,如下：-Dos.name&#x3D;windows<br><img src="/zhangyangibm/images/20210313/0013.png" alt="Windows" title="Windows"><br>验证运行结果<br><img src="/zhangyangibm/images/20210313/0014.png" alt="console" title="console"></p>
<h4 id="1-6-导入组件的三种用法"><a href="#1-6-导入组件的三种用法" class="headerlink" title="1.6 导入组件的三种用法"></a>1.6 导入组件的三种用法</h4><ul>
<li>方法1:通过使用 <strong>@Import</strong> 注解将组件导入，id默认是组件的全类名</li>
</ul>
<p>模拟场景：假设此时已经创建了两个工具类，Tools1.java和Tools2.java，此时需要导入到类中，使用@Import（组件名.class）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(&#123;Tools1.class,Tools2.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfig1</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/images/20210313/0015.png" alt="Import" title="Import"></p>
<ul>
<li>方法2:ImportSelecter接口。该方式需要实现ImportSelector接口,返回需要导入的组件的全类名数组.</li>
</ul>
<p>模拟场景：创建一个类MyImportSelecter，实现ImportSelector接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyImportSelecter</span> <span class="keyword">implements</span> <span class="title class_">ImportSelector</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回值要导入到容器中的组件全类名 com.zhy.beans.Tools3</span></span><br><span class="line">    <span class="comment">//AnnotationMetadata：当前标注@Import注释的类的所有信息</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">    <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;com.zhy.beans.Tools3&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将MyImportSelecter类 通过@import中导入到目标控件中<br>@Import({Tools1.class,Tools2.class,MyImportSelecter.class})<br><img src="/zhangyangibm/images/20210313/0016.png" alt="Import" title="Import"></p>
<ul>
<li>手动注册Bean到容器中。实现ImportBeanDefinitionRegistrar接口。</li>
</ul>
<p>模拟场景：创建一个tool.java，实现ImportBeanDefinitionRegistrar接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyImportBeanDefinitionRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span> &#123;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* importingClassMetadata：当前类的信息</span></span><br><span class="line"><span class="comment">* BeanDefinitionRegistry：注册类</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">	<span class="comment">//检索容器中的信息，查看时候包含Tools1和Tools3</span></span><br><span class="line">	<span class="type">boolean</span> <span class="variable">definition1</span> <span class="operator">=</span> registry.containsBeanDefinition(<span class="string">&quot;com.zhy.beans.Tools1&quot;</span>);</span><br><span class="line">	<span class="type">boolean</span> <span class="variable">definition2</span> <span class="operator">=</span> registry.containsBeanDefinition(<span class="string">&quot;com.zhy.beans.Tools3&quot;</span>);</span><br><span class="line">    <span class="comment">//如果存在的化注册Tools4</span></span><br><span class="line">		<span class="keyword">if</span>(definition2 &amp;&amp; definition1) &#123;</span><br><span class="line">			<span class="type">RootBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(Tools4.class);</span><br><span class="line">            <span class="comment">//参数一：指定的bean名</span></span><br><span class="line">			<span class="comment">//参数二：注册信息</span></span><br><span class="line">			registry.registerBeanDefinition(<span class="string">&quot;Tools4&quot;</span>, beanDefinition);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果<br><img src="/zhangyangibm/images/20210313/0017.png" alt="Import" title="Import"></p>
<h4 id="1-7-FactoryBean（工厂Bean）"><a href="#1-7-FactoryBean（工厂Bean）" class="headerlink" title="1.7 FactoryBean（工厂Bean）"></a>1.7 FactoryBean（工厂Bean）</h4><p>使用Spring提供的FactoryBean（工厂Bean）给容器注册组件。<br>区别于普通的Bean，通常来说Spring创建对象的时候的需要调用bean内部的无参构造方法，创建对象之后注册在容器中，FactoryBean是一个接口，容器会调用其中的getObject方法，创建对象，将对象放在容器中。<br>接口构成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">T <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception; </span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; getObjectType();  </span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模拟场景：创建一个ToolsFactory实现FactoryBean接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个Spring定义的FactoryBean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ToolsFactory</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;T&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回一个Tools1对象，整个对象将会添加到容器中</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;创建 Tools1&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> (T) <span class="keyword">new</span> <span class="title class_">Tools1</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回值类型</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">            <span class="keyword">return</span> Tools1.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 控制是否单例</span></span><br><span class="line"><span class="comment">    * true：单例，在容器中只有一份</span></span><br><span class="line"><span class="comment">    * false：多实例，每次都创建一个</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将bean注册在容器的配置中<br><img src="/zhangyangibm/images/20210313/0018.png" alt="FactoryBean" title="FactoryBean"></p>
<p>启动之后，从Spring容器中获取Bean，<br>测试单实例情况</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testImport</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">AnnotationConfigApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(</span><br><span class="line">	MainConfig1.class);</span><br><span class="line"></span><br><span class="line">	<span class="type">Object</span> <span class="variable">bean1</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;ToolsFactoryBean&quot;</span>);</span><br><span class="line">	<span class="type">Object</span> <span class="variable">bean2</span> <span class="operator">=</span> applicationContext.getBean(<span class="string">&quot;ToolsFactoryBean&quot;</span>);</span><br><span class="line">	<span class="comment">//工厂Bean获取的是调用getObject创建的对象</span></span><br><span class="line">	System.out.println(bean1==bean2);</span><br><span class="line">	</span><br><span class="line">	String[] methodname = applicationContext.getBeanDefinitionNames();</span><br><span class="line">	<span class="comment">// 获取容器类的名字</span></span><br><span class="line">	<span class="keyword">for</span> (String name : methodname) &#123;</span><br><span class="line">	System.out.println(name);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/images/20210313/0019.png" alt="FactoryBean" title="FactoryBean"><br>测试多实例情况</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/images/20210313/0020.png" alt="FactoryBean" title="FactoryBean"></p>
<h4 id="1-8-Bean的生命周期"><a href="#1-8-Bean的生命周期" class="headerlink" title="1.8 Bean的生命周期"></a>1.8 Bean的生命周期</h4><p>Bean的生命周期：Bean的创建create、Bean的初始化init、Bean的销毁destory。<br>Spring容器管理bean的生命周期，可以自定义初始化和销毁方法； Spring容器在Bean进行到当前生命周期的时候来调用自定义的初始化和销毁方法。</p>
<ul>
<li>方法一：@Bean注解属性init-method 和 destory-method<br>模拟场景：<br>创建一个普通的Car对象,如下：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line">	<span class="comment">//无参构造方法</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Car</span><span class="params">()</span> &#123;</span><br><span class="line">	    System.out.println(<span class="string">&quot;car constructor....&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//自定义初始化方法</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">	    System.out.println(<span class="string">&quot;car init &quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//自定义销毁方法</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destory</span><span class="params">()</span> &#123;</span><br><span class="line">	    System.out.println(<span class="string">&quot;car destory&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
在以往使用xml文件时，<Bean>标签内有两个属性，init-method 和 destory-method，同样在使用注解方式的时候也是有同样的属性，initMethod（初始化方法） 和 destroyMethod（销毁方法）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfigOfLifeCycle</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(value = &quot;car_id1&quot;, initMethod = &quot;init&quot;, destroyMethod = &quot;destory&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Car <span class="title function_">cars</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Car</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
当标记完两个注解属性之后，初始化时通过initMethod对应的方法名会找到当前对象也就是car的init方法完成初始化，同样销毁时会调用destroyMethod属性对应的方法destory完成Bean的销毁。<br>测试启动<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建IoC容器</span></span><br><span class="line">    <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(</span><br><span class="line">    MainConfigOfLifeCycle.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;容器创建完成......&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/zhangyangibm/images/20210313/0021.png" alt="Bean" title="Bean"></li>
</ul>
<p>单实例Bean在容器负责管理，当容器关闭的时候，对象销毁。<br>测试启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1.创建IoC容器</span></span><br><span class="line">    <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(</span><br><span class="line">    MainConfigOfLifeCycle.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;容器创建完成......&quot;</span>);</span><br><span class="line">    <span class="comment">//2.管理容器，对象销毁</span></span><br><span class="line">    applicationContext.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/images/20210313/0022.png" alt="Bean" title="Bean"></p>
<ul>
<li>方法二：通过bean实现InitializingBean和DisposableBean接口 管理Bean的生命周期<br>这两个接口分别负责做初始化和销毁</li>
</ul>
<p>模拟场景：<br>首先创建一个类Company，实现 InitializingBean（负责初始化）和DisposableBean（负责销毁）接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Company</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span>,DisposableBean&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.out.println(<span class="string">&quot;company Start&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.out.println(<span class="string">&quot;company destroy&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>容器扫描</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.zhy.LifeCycle&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfigOfLifeCycle</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动测试：伴随容器启动，初始化进行；伴随关闭容器，对象销毁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IOCTest_LifeCycle</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//1.创建IoC容器</span></span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(</span><br><span class="line">        MainConfigOfLifeCycle.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;容器创建完成......&quot;</span>);</span><br><span class="line">        <span class="comment">//2.关闭容器，对象销毁</span></span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/images/20210313/0023.png" alt="Bean" title="Bean"></p>
<ul>
<li>方法三：使用JSR250<br>准确的说这种方法不是Spring容器提供的方法，**@PostConstruct**，在Bean创建完成在、并且属性赋值完成，来执行初始化。在容器销毁Bean之前通知我们进行清理工作，@PerDestory 销毁，以下简单的事例：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Color</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Color</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot; color constructor &quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// PostConstruct:对象创建并赋值之后初始化</span></span><br><span class="line">	<span class="meta">@PostConstruct</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot; color inited &quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// PerDestroy：容器移除对象之前销毁</span></span><br><span class="line">	<span class="meta">@PerDestroy</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destory</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot; color destory &quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>方法四：bean的后置处理器，实现BeanPostProcessor接口<br>其中有两个方法，在Bean初始化前后进行一些处理<br>postProcessBeforeInitialization：在bean初始化之前工作<br>postProcessAfterInitialization：在bean初始化之后工作  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 后置处理器，初始化前后进行处理工作</span></span><br><span class="line"><span class="comment"> * 将后置处理器加入到容器中</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhangyang</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span>&#123;</span><br><span class="line">    <span class="comment">//在bean初始化之前工作 </span></span><br><span class="line">	<span class="keyword">public</span>  Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean,String beanName)</span> <span class="keyword">throws</span> BeansException&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;postProcessBeforeInitialization&quot;</span>+beanName+bean);</span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在bean初始化之后工作</span></span><br><span class="line">	<span class="keyword">public</span>  Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean,String beanName)</span> <span class="keyword">throws</span> BeansException&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;postProcessAfterInitialization&quot;</span>+beanName+bean);</span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
测试调用：以Company为例，当company创建之前，调用初始化前置方法postProcessBeforeInitialization方法被调用，在初始化之后调用后置postProcessAfterInitialization方法被调用，如下：<br><img src="/zhangyangibm/images/20210313/0024.png" alt="Bean" title="Bean"></li>
</ul>
<p>初始化执行的顺序：</p>
<p>通过查看Spring的源码可以看执行结构  </p>
<p>目的是执行Bean的初始化，但是在初始化之前将会执行populateBean，<strong>populateBean</strong> 是给Bean进行属性赋值，赋值完成之后才肯开始调用initializeBean真正的开始钱Bean的初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Initialize the bean instance.</span></span><br><span class="line">		<span class="type">Object</span> <span class="variable">exposedObject</span> <span class="operator">=</span> bean;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">			exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">			<span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</span><br><span class="line">				<span class="keyword">throw</span> (BeanCreationException) ex;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">						mbd.getResourceDescription(), beanName, <span class="string">&quot;Initialization of bean failed&quot;</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>第一步、前置方法<br>applyBeanPostProcessorsBeforeInitialization</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//源码：首先找到所有的BeanPostProcessors，遍历执行postProcessBeforeInitialization，一但是null遍历结束，之后的BeanPostProcessors不会执行</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">applyBeanPostProcessorsBeforeInitialization</span><span class="params">(Object existingBean, String beanName)</span></span><br><span class="line">		<span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> existingBean;</span><br><span class="line">	<span class="keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;</span><br><span class="line">		<span class="type">Object</span> <span class="variable">current</span> <span class="operator">=</span> processor.postProcessBeforeInitialization(result, beanName);</span><br><span class="line">		<span class="keyword">if</span> (current == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">		result = current;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二步、执行初始化方法<br>invokeInitMethods</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Give a bean a chance to react now all its properties are set,</span></span><br><span class="line"><span class="comment"> * and a chance to know about its owning bean factory (this object).</span></span><br><span class="line"><span class="comment"> * This means checking whether the bean implements InitializingBean or defines</span></span><br><span class="line"><span class="comment"> * a custom init method, and invoking the necessary callback(s) if it does.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanName the bean name in the factory (for debugging purposes)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bean the new bean instance we may need to initialize</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mbd the merged bean definition that the bean was created with</span></span><br><span class="line"><span class="comment"> * (can also be &#123;<span class="doctag">@code</span> null&#125;, if given an existing bean instance)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Throwable if thrown by init methods or by the invocation process</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #invokeCustomInitMethod</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">invokeInitMethods</span><span class="params">(String beanName, <span class="keyword">final</span> Object bean, <span class="meta">@Nullable</span> RootBeanDefinition mbd)</span></span><br><span class="line">		<span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">boolean</span> <span class="variable">isInitializingBean</span> <span class="operator">=</span> (bean <span class="keyword">instanceof</span> InitializingBean);</span><br><span class="line">	<span class="keyword">if</span> (isInitializingBean &amp;&amp; (mbd == <span class="literal">null</span> || !mbd.isExternallyManagedInitMethod(<span class="string">&quot;afterPropertiesSet&quot;</span>))) &#123;</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">&quot;Invoking afterPropertiesSet() on bean with name &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">					((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">				&#125;, getAccessControlContext());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (PrivilegedActionException pae) &#123;</span><br><span class="line">				<span class="keyword">throw</span> pae.getException();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mbd != <span class="literal">null</span> &amp;&amp; bean.getClass() != NullBean.class) &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">initMethodName</span> <span class="operator">=</span> mbd.getInitMethodName();</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasLength(initMethodName) &amp;&amp;</span><br><span class="line">				!(isInitializingBean &amp;&amp; <span class="string">&quot;afterPropertiesSet&quot;</span>.equals(initMethodName)) &amp;&amp;</span><br><span class="line">				!mbd.isExternallyManagedInitMethod(initMethodName)) &#123;</span><br><span class="line">			invokeCustomInitMethod(beanName, bean, mbd);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第三步、后置方法<br>applyBeanPostProcessorsAfterInitialization</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//Spring源码：后置方法的时候与前置的处理方式相同</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">applyBeanPostProcessorsAfterInitialization</span><span class="params">(Object existingBean, String beanName)</span></span><br><span class="line">		<span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> existingBean;</span><br><span class="line">	<span class="keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;</span><br><span class="line">		<span class="type">Object</span> <span class="variable">current</span> <span class="operator">=</span> processor.postProcessAfterInitialization(result, beanName);</span><br><span class="line">		<span class="keyword">if</span> (current == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">		result = current;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Spring底层对BeanPostProcessor还有很多的实现<br>例如Bean的赋值，注入其他组件，@Autowired，生命周期注解功能，@Async等很多</p>
<p>首先查看目录层级，以ApplicationContextAwareProcessor例：<br><img src="/zhangyangibm/images/20210313/0025.png" alt="Bean" title="Bean"><br>class ApplicationContextAwareProcessor implements BeanPostProcessor<br>ApplicationContextAwareProcessor的作用是帮助开发者注入IOC容器</p>
<p>模拟场景：创建一个class实现ApplicationContextAware接口，以Weather类为例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Weather</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Weather</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、将Spring容器私有化定义到Bean，</span></span><br><span class="line">	<span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2、通过setApplicationContext方法将会传入的applicationContext容器引入</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="built_in">this</span>.applicationContext=applicationContext;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上的功能主要是由ApplicationContextAwareProcessor实现的，在这个方法中有一个方法：postProcessBeforeInitialization，在Weather对象创建之前完成一系列方法功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//Spring源码</span></span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(<span class="keyword">final</span> Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">	<span class="type">AccessControlContext</span> <span class="variable">acc</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">			(bean <span class="keyword">instanceof</span> EnvironmentAware || bean <span class="keyword">instanceof</span> EmbeddedValueResolverAware ||</span><br><span class="line">					bean <span class="keyword">instanceof</span> ResourceLoaderAware || bean <span class="keyword">instanceof</span> ApplicationEventPublisherAware ||</span><br><span class="line">					bean <span class="keyword">instanceof</span> MessageSourceAware || bean <span class="keyword">instanceof</span> ApplicationContextAware)) &#123;</span><br><span class="line">		acc = <span class="built_in">this</span>.applicationContext.getBeanFactory().getAccessControlContext();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (acc != <span class="literal">null</span>) &#123;</span><br><span class="line">		AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">			invokeAwareInterfaces(bean);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;, acc);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		invokeAwareInterfaces(bean);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-9-属性赋值"><a href="#1-9-属性赋值" class="headerlink" title="1.9 属性赋值"></a>1.9 属性赋值</h4><p>在xml模式中，对属性分赋值使用Bean标签可以实现</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">	   http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">	   http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">	   http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">	   http://www.springframework.org/schema/context/spring-context-3.0.xsd&quot;</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!-- 创建对象 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;person&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.zhy.beans.Person&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;18&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Jack&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过注解的方式也可以实现对属性的赋值，**@Value**</p>
<p>实现的方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">以Person类为例，使用<span class="meta">@Value</span>注解对三个成员变量进行赋值</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 使用@Value赋值</span></span><br><span class="line">	<span class="comment">// 方式一：基本数值</span></span><br><span class="line">	<span class="meta">@Value(&quot;Mark&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 方式二：可以写ApEL #&#123;&#125;</span></span><br><span class="line">	<span class="meta">@Value(&quot;#&#123;30-2&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String age;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 方式三：$&#123;&#125; 可以取出配置文件[properties]中的值，在运行环境变量中的值</span></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;Person.salary&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> Double salary;</span><br><span class="line">	</span><br><span class="line">	……get/set方法</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建配置类Configuration对其进行配置</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfigOfPropertyValues</span> &#123;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> Person <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方式一：基本数值<br>@Value(“Mark”)</p>
<p>方式二：可以写ApEL #{}，可以直接写表达式<br>@Value(“#{30-2}”)</p>
<p>方式三：${} 可以取出配置文件[properties]中的值，在运行环境变量中的值<br>@Value(“${Person.salary}”)<br>创建一个配置文件person.properties，</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person.salary=10299.10</span><br></pre></td></tr></table></figure>
<p>xml模式中需要引入配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">   http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">   http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">   http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">   http://www.springframework.org/schema/context/spring-context-3.0.xsd&quot;</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:/person.properties&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>而在注解模式中可以使用 <strong>@PropertySource</strong> 引入配置配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用@PropertySource读取配置文件[person.properties]中的可k、v值保存到运行的环境变量中</span></span><br><span class="line"><span class="meta">@PropertySource(value=&#123;&quot;classpath:/person.properties&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfigOfPropertyValues</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> Person <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/images/20210313/0027.png" alt="Bean" title="Bean"></p>
<h4 id="2-0-自动装配"><a href="#2-0-自动装配" class="headerlink" title="2.0 自动装配"></a>2.0 自动装配</h4><p>Spring使用依赖注入（DI）的方式完成对IOC容器中各个组件中依赖关系分赋值；<br>在传统的开发模式中通常是三层调用模式，col➡️service➡️dao，当sevice中需要dao方法的时候通常需要在Service中创建dao对象，现在创建Dao对象的步骤是由Spring容器创建完成了，需要做的是如何将dao装配到Service中。</p>
<ul>
<li>实现方式1: <strong>@Autowired</strong>注解<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">springService</span> &#123;</span><br><span class="line">	<span class="meta">@Autowired</span> </span><br><span class="line">	<span class="keyword">private</span> springDao springDao;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;springDao-------&gt;&quot;</span> + springDao);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;springService [springDao=&quot;</span> + springDao + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.zhy.Service&quot;,&quot;com.zhy.Dao&quot;,&quot;com.zhy.Controller&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfigAutowired</span> &#123;</span><br><span class="line">	<span class="meta">@Bean(&quot;springDao2&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> springDao <span class="title function_">springDaos</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">springDao</span> <span class="variable">springdao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">springDao</span>();</span><br><span class="line">		springdao.setLable(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> springdao;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
启动测试，此时一个单实例的dao在Service中装配完成<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IOCTest_Autowired</span> &#123;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//创建IoC容器</span></span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(</span><br><span class="line">        MainConfigAutowired.class);</span><br><span class="line">        </span><br><span class="line">        <span class="type">springService</span> <span class="variable">springService</span> <span class="operator">=</span> applicationContext.getBean(springService.class);</span><br><span class="line">        System.out.println(springService);</span><br><span class="line">        </span><br><span class="line">        <span class="type">springDao</span> <span class="variable">springDao</span> <span class="operator">=</span> applicationContext.getBean(springDao.class); </span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;容器中的SpringDao-----&gt;&quot;</span>+springDao);</span><br><span class="line">        </span><br><span class="line">        applicationContext.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/zhangyangibm/images/20210313/0028.png" alt="Autowried" title="Autowried"></li>
</ul>
<p>基本原理：</p>
<ol>
<li>默认优先按照类型到容器中找对应的组件，如果找到就赋值。</li>
<li>如果找到多个类型的组件，再将属性名称作为组件的Id去容器中查找</li>
<li>@Qualifier(“springDao”)：使用注解@Qualifier指定需要装配的组件的id，而不是使用属性名</li>
<li>自动装配时，一定要在要将属性赋好值，否则会报错 ,如果不需要装配还可以使用@Autowired(required &#x3D; false)指定required</li>
<li>@Primary注解 让Spring进行自动装配的时候默认使用首选的bean，<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.zhy.Service&quot;,&quot;com.zhy.Dao&quot;,&quot;com.zhy.Controller&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfigAutowired</span> &#123;</span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean(&quot;springDao2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> springDao <span class="title function_">springDao</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">springDao</span> <span class="variable">springdao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">springDao</span>();</span><br><span class="line">        springdao.setLable(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> springdao;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>除了@Autowried注解以外，Spring还支持Java规范的注解@Resource(JSR250规范) 和 @Inject(JSR330规范) 自动注入，<br>（1）、@Resource是按照属性名称进行装配的，不支持@Qualifier和@Autowired(required &#x3D; false)和@Primary<br>（2）、@Inject，和@Autowired 一样，但是没有@Autowired(required &#x3D; false)</p>
<ul>
<li>实现方式2: <strong>@Autowired</strong>注解可以标记在构造器、参数、方法、属性上</li>
</ul>
<p>模拟场景：创建一个Boss，成员变量是car</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Car对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhangyang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Car</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;car constructor....&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;car init &quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destory</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;car destory&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Boss</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> Car car;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Boss</span><span class="params">(Car car)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.car=car;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Car <span class="title function_">getCar</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> car;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCar</span><span class="params">(Car car)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.car = car;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;Boss [car=&quot;</span> + car + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.zhy.Service&quot;,&quot;com.zhy.Dao&quot;,&quot;com.zhy.Controller&quot;,&quot;com.zhy.beans&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfigAutowired</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Primary</span></span><br><span class="line">	<span class="meta">@Bean(&quot;springDao2&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> springDao <span class="title function_">springDao</span><span class="params">()</span> &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="type">springDao</span> <span class="variable">springdao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">springDao</span>();</span><br><span class="line">		springdao.setLable(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> springdao;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方式一：注意到上边的@Autowired标注在了方法上，Spring容器创建对象时就会调用方法完成赋值，方法使用的参数自定义类型的值从IOC容器中获取@Autowired<br>@Autowired<br>public void setCar(Car car) {<br>    this.car &#x3D; car;<br>}<br>也就是说这个car是从Ioc容器中获取的，打印<br><img src="/zhangyangibm/images/20210313/0029.png" alt="Autowried" title="Autowried"></p>
<p><strong>注意：如果只有一个参构造器，@Autowired是可以省去不写</strong></p>
<p>方式二：这里需要需要注意，默认加在ICO容器的组件，容器启动会调用无参构造器创建对象，在进行赋值操作。当boss中含有一个有参构造器,并且加上@Autowired注解的时候，Spring在启动的时候就会调用这个有参构造器。<br>public Boss(Car car) {<br>    this.car&#x3D;car;<br>}</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Boss</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Car car;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Boss</span><span class="params">(Car car)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.car=car;</span><br><span class="line">        System.out.println(<span class="string">&quot;Boss的有参构造器...&quot;</span>+car);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Car <span class="title function_">getCar</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> car;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCar</span><span class="params">(Car car)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.car = car;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Boss [car=&quot;</span> + car + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/images/20210313/0030.png" alt="Autowried" title="Autowried"></p>
<p>方式三：**@Autowired** 标记的位置可以标记在方法上也可以标记在参数上,最终的目的是一样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCar</span><span class="params">(<span class="meta">@Autowired</span> Car car)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Boss</span><span class="params">( <span class="meta">@Autowired</span> Car car)</span> </span><br></pre></td></tr></table></figure>

<ul>
<li>实现方式3: 底层组件注册。如果是自定义组件想要使用Spring容器底层的一些组件（ApplicationContext、BeanFactory、xxx），需要让自定义组件实现xxxAware接口,在创建对象的时候会调用规定的方法注入相关组件<br>关于Aware接口，Spring给出这样的描述,<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A marker superinterface indicating that a bean is eligible to be notified by the</span></span><br><span class="line"><span class="comment"> * Spring container of a particular framework object through a callback-style method.</span></span><br><span class="line"><span class="comment"> * The actual method signature is determined by individual subinterfaces but should</span></span><br><span class="line"><span class="comment"> * typically consist of just one void-returning method that accepts a single argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Note that merely implementing &#123;<span class="doctag">@link</span> Aware&#125; provides no default functionality.</span></span><br><span class="line"><span class="comment"> * Rather, processing must be done explicitly, for example in a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.beans.factory.config.BeanPostProcessor&#125;.</span></span><br><span class="line"><span class="comment"> * Refer to &#123;<span class="doctag">@link</span> org.springframework.context.support.ApplicationContextAwareProcessor&#125;</span></span><br><span class="line"><span class="comment"> * for an example of processing specific &#123;<span class="doctag">@code</span> *Aware&#125; interface callbacks.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Chris Beams</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Aware</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
实际上Aware派生的接口非常的多<br><img src="/zhangyangibm/images/20210313/0031.png" alt="Aware" title="Aware"></li>
</ul>
<p>以下只选取个别的接口<br>ApplicationContextAware,BeanNameAware,EmbeddedValueResolverAware</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tools1</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span>,BeanNameAware,EmbeddedValueResolverAware&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获取当前的IOC容器</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.out.println(<span class="string">&quot;传入的IOC容器...&quot;</span>+applicationContext);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取当前bean的名字</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.out.println(<span class="string">&quot;当前bean的名字...&quot;</span>+name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//解析字符</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEmbeddedValueResolver</span><span class="params">(StringValueResolver resolver)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		String stringValueResolver=resolver.resolveStringValue(<span class="string">&quot;你好 $&#123;os.name&#125;  我今年 #&#123;4*7&#125; 岁&quot;</span>);</span><br><span class="line">		System.out.println(stringValueResolver);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IOCTest_Autowired</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">//创建IoC容器</span></span><br><span class="line">		<span class="type">AnnotationConfigApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(</span><br><span class="line">				MainConfigAutowired.class);</span><br><span class="line">		</span><br><span class="line">		applicationContext.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/images/20210313/0032.png" alt="Aware" title="Aware"></p>
<ul>
<li>@Profile注解<br>Spring为我们提供的可以根据当前环境动态的激活和切换一系列组件的功能</li>
</ul>
<p>pom.xml引入<br>数据源：C3P0</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/c3p0/c3p0 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>数据库驱动：mysql</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>模拟场景：配置文件中设置三种数据库的链接方式，生产模式（prod），测试模式（test），开发模式（dev）。新建数据库基本属性文件（dbconfig.properties），需要创建一个配置类，一个测试启动类</p>
<figure class="highlight xml"><figcaption><span>dbconfig.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.user=root</span><br><span class="line">db.password=11111</span><br><span class="line">db.DriverClass=com.mysql.jdbc.Driver</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PropertySource(value=&#123;&quot;classpath:/dbconfig.properties&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfigProfile</span> <span class="keyword">implements</span> <span class="title class_">EmbeddedValueResolverAware</span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;db.user&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String username;</span><br><span class="line">	<span class="keyword">private</span> StringValueResolver driverClass;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> DataSource <span class="title function_">dataSourceTest</span><span class="params">(<span class="meta">@Value(&quot;$&#123;db.password&#125;&quot;)</span>String pwd)</span> <span class="keyword">throws</span> PropertyVetoException &#123;</span><br><span class="line">		<span class="type">ComboPooledDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComboPooledDataSource</span>();</span><br><span class="line">		dataSource.setUser(username);</span><br><span class="line">		dataSource.setPassword(pwd);</span><br><span class="line">		dataSource.setJdbcUrl(<span class="string">&quot;jdbc:mysql://192.168.0.105:3306/mango&quot;</span>);</span><br><span class="line">		<span class="type">String</span> <span class="variable">dc</span> <span class="operator">=</span> driverClass.resolveStringValue(<span class="string">&quot;$&#123;db.password&#125;&quot;</span>);</span><br><span class="line">		dataSource.setDriverClass(dc);</span><br><span class="line">		<span class="keyword">return</span> dataSource;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> DataSource <span class="title function_">dataSourceDev</span><span class="params">(<span class="meta">@Value(&quot;$&#123;db.password&#125;&quot;)</span>String pwd)</span> <span class="keyword">throws</span> PropertyVetoException &#123;</span><br><span class="line">		<span class="type">ComboPooledDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComboPooledDataSource</span>();</span><br><span class="line">		dataSource.setUser(username);</span><br><span class="line">		dataSource.setPassword(pwd);</span><br><span class="line">		dataSource.setJdbcUrl(<span class="string">&quot;jdbc:mysql://192.168.0.105:3306/mango&quot;</span>);</span><br><span class="line">		dataSource.setDriverClass(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> dataSource;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> DataSource <span class="title function_">dataSourceProd</span><span class="params">(<span class="meta">@Value(&quot;$&#123;db.password&#125;&quot;)</span>String pwd)</span> <span class="keyword">throws</span> PropertyVetoException &#123;</span><br><span class="line">		<span class="type">ComboPooledDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComboPooledDataSource</span>();</span><br><span class="line">		dataSource.setUser(username);</span><br><span class="line">		dataSource.setPassword(pwd);</span><br><span class="line">		dataSource.setJdbcUrl(<span class="string">&quot;jdbc:mysql://192.168.0.105:3306/mango&quot;</span>);</span><br><span class="line">		dataSource.setDriverClass(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> dataSource;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEmbeddedValueResolver</span><span class="params">(StringValueResolver resolver)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="built_in">this</span>.driverClass = resolver;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IOCTest_Profile</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">//1.创建IoC容器</span></span><br><span class="line">		<span class="type">AnnotationConfigApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(</span><br><span class="line">				MainConfigProfile.class);</span><br><span class="line">		String[] nameForType = applicationContext.getBeanNamesForType(DataSource.class);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span>(String str : nameForType) &#123;</span><br><span class="line">			System.out.println(str);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//2.管理容器，对象销毁</span></span><br><span class="line">		applicationContext.close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显示结果：<br><img src="/zhangyangibm/images/20210313/0033.png" alt="Profile" title="Profile"></p>
<p>@Profile注解：指定组件在那个环境的情况下才能被注册到容器中,添加环境标识之后只有添加的环境标识的时候才可以启动注册到容器中，默认是default环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile(&quot;default&quot;)</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> DataSource <span class="title function_">dataSourceTest</span><span class="params">(<span class="meta">@Value(&quot;$&#123;db.password&#125;&quot;)</span>String pwd)</span> <span class="keyword">throws</span> PropertyVetoException &#123;</span><br><span class="line">		<span class="type">ComboPooledDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComboPooledDataSource</span>();</span><br><span class="line">		dataSource.setUser(username);</span><br><span class="line">		dataSource.setPassword(pwd);</span><br><span class="line">		dataSource.setJdbcUrl(<span class="string">&quot;jdbc:mysql://192.168.0.105:3306/mango&quot;</span>);</span><br><span class="line">		<span class="type">String</span> <span class="variable">dc</span> <span class="operator">=</span> driverClass.resolveStringValue(<span class="string">&quot;$&#123;db.password&#125;&quot;</span>);</span><br><span class="line">		dataSource.setDriverClass(dc);</span><br><span class="line">		<span class="keyword">return</span> dataSource;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>


<p>启动方式一：通过Eclipse配置修改运行环境</p>
<p><img src="/zhangyangibm/images/20210313/0034.png" alt="Profile" title="Profile"><br>对应修改 <strong>-Dspring.profiles.active&#x3D;dev</strong><br><img src="/zhangyangibm/images/20210313/0035.png" alt="Profile" title="Profile"><br>控制台显示结果启动切换到了dev环境<br><img src="/zhangyangibm/images/20210313/0036.png" alt="Profile" title="Profile"></p>
<p>启动方式二：代码启动,调用无参构造器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IOCTest_Profile</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">//1.创建IoC容器</span></span><br><span class="line">		<span class="type">AnnotationConfigApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>();</span><br><span class="line">		<span class="comment">//2、设置需要激活的环境</span></span><br><span class="line">		applicationContext.getEnvironment().setActiveProfiles(<span class="string">&quot;prod&quot;</span>,<span class="string">&quot;dev&quot;</span>);</span><br><span class="line">		<span class="comment">//3、注册主配置类</span></span><br><span class="line">		applicationContext.register(MainConfigProfile.class);</span><br><span class="line">		<span class="comment">//4、启动刷新容器</span></span><br><span class="line">		applicationContext.refresh();</span><br><span class="line">		</span><br><span class="line">		String[] nameForType = applicationContext.getBeanNamesForType(DataSource.class);</span><br><span class="line">		<span class="keyword">for</span>(String str : nameForType) &#123;</span><br><span class="line">			System.out.println(str);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//管理容器，对象销毁</span></span><br><span class="line">		applicationContext.close();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>验证启动完成<br><img src="/zhangyangibm/images/20210313/0037.png" alt="Profile" title="Profile"></p>
<h3 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h3><p>AOP（Aspect Oriented Programming）<br>事务（Transaction）</p>
<h3 id="1、AOP"><a href="#1、AOP" class="headerlink" title="1、AOP"></a>1、AOP</h3><p>环境配置<br>导入Spring相关的jar包，在maven仓库（<a target="_blank" rel="noopener" href="https://mvnrepository.com)里找到spring/">https://mvnrepository.com）里找到spring</a> aspects,选择5.1.10版本,配置到pom.xml中<br><img src="/zhangyangibm/images/20210314/0038.png" alt="Eclipse" title="Eclipse"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aspects<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="1-1、面向切面实现流程"><a href="#1-1、面向切面实现流程" class="headerlink" title="1.1、面向切面实现流程"></a>1.1、面向切面实现流程</h4><p>对AOP的理解：AOP是指在程序运行期间动态的将某一段代码切入到指定方法的指定位置的编程方式，其根本就是动态代理。</p>
<p>下面简单写一个案例：<br>1、首先创建一个新的包Aop：package com.zhy.aop，创建一个新的逻辑类MathCalculator.java，写一个简单的计算除法的逻辑。<br>目的是在逻辑运行之前、运行结束、出现异常的时候记录运行日志。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MathCalculator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">div</span><span class="params">(<span class="type">int</span> i,<span class="type">int</span> j)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> i/j;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、为了实现这个功能需要建立一个切面，定一个切面类LogAspacts.java<br>在AOP模式中Spring还提供了很多的通知方法，包括：<br>    * 前置通知：**@Before** 在目标方法执行之前进行切入。logStart<br>    * 后置通知：**@After** 在目标方法运行结束之后切入（无论正常还是异常）。logEnd<br>    * 返回通知：**@AfterReturning** 在目标方法正常返回之后。logReturn<br>    * 异常通知：**@AfterThrowing** 在目标方法发生异常之后。logError<br>    * 环绕通知：**@Around** 动态代理，手动的推进目标方法运行（joinPoint.procced（））</p>
<p>3、为了告诉Spring这是切面，因此需要用到一个注解 <strong>@Aspect</strong>，这样Spring就会自动感知。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAspacts</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽取公共的切入点表达式</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(public int com.zhy.aop.MathCalculator.div(int, int))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pointCut</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目标方法之前切入（指定在哪个方法切入）</span></span><br><span class="line">    <span class="comment">// @Before(&quot;public int com.zhy.aop.MathCalculator.*(..)&quot;)</span></span><br><span class="line">    <span class="meta">@Before(&quot;pointCut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logStart</span><span class="params">(JoinPoint joinPoint)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;逻辑开始运行@Before：&quot;</span> + joinPoint.getSignature().getName() + <span class="string">&quot;参数列表：&#123;&quot;</span></span><br><span class="line">                + Arrays.asList(joinPoint.getArgs()) + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无论方法正常还是异常结束都会通知</span></span><br><span class="line">    <span class="meta">@After(&quot;com.zhy.aop.LogAspacts.pointCut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logEnd</span><span class="params">(JoinPoint joinPoint)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;逻辑运行结束@After&quot;</span>+ joinPoint.getSignature().getName() + <span class="string">&quot;参数列表：&#123;&quot;</span></span><br><span class="line">                + Arrays.asList(joinPoint.getArgs()) + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方法正常返回</span></span><br><span class="line">    <span class="meta">@AfterReturning(value=&quot;pointCut()&quot;,returning=&quot;result&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logReturn</span><span class="params">(Object result)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;逻辑正常结束，@AfterReturning打印结果：&#123;&quot;</span>+result+<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方法发生异常时：*注意：joinPoint一定是第一个参数</span></span><br><span class="line">    <span class="meta">@AfterThrowing(value=&quot;pointCut()&quot;,throwing = &quot;exception&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logError</span><span class="params">(JoinPoint joinPoint,Exception exception)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;逻辑运行异常，@AfterThrowing打印信息：&#123;&quot;</span>+exception+<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4、需要将所有的控件放在配置文件中，需要注意一点，加入配置类的同时需要开启AOP功能，使用<strong>EnableAspectJAutoProxy</strong>注解，这就是基于注解的Aop模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfigOfAop</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MathCalculator <span class="title function_">Calculator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MathCalculator</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LogAspacts <span class="title function_">Aspacts</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LogAspacts</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、将切面类和业务逻辑类都需要加入到容器中<br>正常情况</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AOPTest_Aspact</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 创建IoC容器</span></span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(</span><br><span class="line">                MainConfigOfAop.class);</span><br><span class="line">        <span class="comment">//调用容器中的目标方法所在的对象</span></span><br><span class="line">        <span class="type">MathCalculator</span> <span class="variable">mathCalculator</span> <span class="operator">=</span> applicationContext.getBean(MathCalculator.class);</span><br><span class="line"></span><br><span class="line">        mathCalculator.div(<span class="number">6</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/images/20210314/0039.png" alt="Aspect" title="正常"><br>异常情况<br><img src="/zhangyangibm/images/20210314/0040.png" alt="Aspect" title="异常"></p>
<p>总结注解方式实现AOP的重要三步：<br>1、将业务逻辑组件和切面都都加入到容器中，告诉Spring哪个是切面@Aspect<br>2、在切面类上的每一个通知方法上都标注上通知注解，告诉Spring何时何地什么情况运行。<br>3、开启基于注解的AOP模式@EnableAspectJAutoProxy</p>
<h4 id="1-2、AOP面向切面原理"><a href="#1-2、AOP面向切面原理" class="headerlink" title="1.2、AOP面向切面原理"></a>1.2、AOP面向切面原理</h4><p>研究SpringAOP的原理，首先需要从 <strong>@EnableAspectJAutoProxy</strong> 注解开始，因为整个功能的实现也是从这个注解开始的。</p>
<h5 id="1-2-1、-EnableAspectJAutoProxy实现目的"><a href="#1-2-1、-EnableAspectJAutoProxy实现目的" class="headerlink" title="1.2.1、@EnableAspectJAutoProxy实现目的"></a>1.2.1、@EnableAspectJAutoProxy实现目的</h5><p>进一步查看@EnableAspectJAutoProxy注解,查看源码会发现这是一个组合注解，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(AspectJAutoProxyRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAspectJAutoProxy &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Indicate whether subclass-based (CGLIB) proxies are to be created as opposed</span></span><br><span class="line"><span class="comment">	 * to standard Java interface-based proxies. The default is &#123;<span class="doctag">@code</span> false&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">proxyTargetClass</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Indicate that the proxy should be exposed by the AOP framework as a &#123;<span class="doctag">@code</span> ThreadLocal&#125;</span></span><br><span class="line"><span class="comment">	 * for retrieval via the &#123;<span class="doctag">@link</span> org.springframework.aop.framework.AopContext&#125; class.</span></span><br><span class="line"><span class="comment">	 * Off by default, i.e. no guarantees that &#123;<span class="doctag">@code</span> AopContext&#125; access will work.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 4.3.1</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">exposeProxy</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 @Import(AspectJAutoProxyRegistrar.class) 为其注入了组件，进一步查看这个组件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Registers an &#123;<span class="doctag">@link</span> org.springframework.aop.aspectj.annotation.AnnotationAwareAspectJAutoProxyCreator</span></span><br><span class="line"><span class="comment"> * AnnotationAwareAspectJAutoProxyCreator&#125; against the current &#123;<span class="doctag">@link</span> BeanDefinitionRegistry&#125;</span></span><br><span class="line"><span class="comment"> * as appropriate based on a given @&#123;<span class="doctag">@link</span> EnableAspectJAutoProxy&#125; annotation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Chris Beams</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableAspectJAutoProxy</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AspectJAutoProxyRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Register, escalate, and configure the AspectJ auto proxy creator based on the value</span></span><br><span class="line"><span class="comment">	 * of the @&#123;<span class="doctag">@link</span> EnableAspectJAutoProxy#proxyTargetClass()&#125; attribute on the importing</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@code</span> <span class="doctag">@Configuration</span>&#125; class.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(</span></span><br><span class="line"><span class="params">			AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line"></span><br><span class="line">		AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);</span><br><span class="line"></span><br><span class="line">		<span class="type">AnnotationAttributes</span> <span class="variable">enableAspectJAutoProxy</span> <span class="operator">=</span></span><br><span class="line">				AnnotationConfigUtils.attributesFor(importingClassMetadata, EnableAspectJAutoProxy.class);</span><br><span class="line">		<span class="keyword">if</span> (enableAspectJAutoProxy != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (enableAspectJAutoProxy.getBoolean(<span class="string">&quot;proxyTargetClass&quot;</span>)) &#123;</span><br><span class="line">				AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (enableAspectJAutoProxy.getBoolean(<span class="string">&quot;exposeProxy&quot;</span>)) &#123;</span><br><span class="line">				AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码得知AspectJAutoProxyRegistrar实现了ImportBeanDefinitionRegistrar接口，再往下查看这个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ImportBeanDefinitionRegistrar</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Register bean definitions as necessary based on the given annotation metadata of</span></span><br><span class="line"><span class="comment">	 * the importing &#123;<span class="doctag">@code</span> <span class="doctag">@Configuration</span>&#125; class.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Note that &#123;<span class="doctag">@link</span> BeanDefinitionRegistryPostProcessor&#125; types may &lt;em&gt;not&lt;/em&gt; be</span></span><br><span class="line"><span class="comment">	 * registered here, due to lifecycle constraints related to &#123;<span class="doctag">@code</span> <span class="doctag">@Configuration</span>&#125;</span></span><br><span class="line"><span class="comment">	 * class processing.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> importingClassMetadata annotation metadata of the importing class</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> registry current bean definition registry</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ImportBeanDefinitionRegistrar接口在之前提及过，它可以给容器自定义组件；也就是说，在AOP的底层也是通过ImportBeanDefinitionRegistrar接口自定义给容器注册了bean，注册了那个Bean尤其需要了解：</p>
<p>返回实现类可以看到这理存在一个Bean<br>AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);<br><img src="/zhangyangibm/images/20210314/0041.png" alt="Aspect" title="Aspect"><br>进入到内部</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> BeanDefinition <span class="title function_">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> BeanDefinition <span class="title function_">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="params">(</span></span><br><span class="line"><span class="params">        BeanDefinitionRegistry registry, <span class="meta">@Nullable</span> Object source)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> registerOrEscalateApcAsRequired(AnnotationAwareAspectJAutoProxyCreator.class, registry, source);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看这个内部和调用关系可以看到，在registerOrEscalateApcAsRequired的方法中，提到了一个组件AnnotationAwareAspectJAutoProxyCreator.class，这个class就是需要注册的<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> BeanDefinition <span class="title function_">registerOrEscalateApcAsRequired</span><span class="params">(</span></span><br><span class="line"><span class="params">        Class&lt;?&gt; cls, BeanDefinitionRegistry registry, <span class="meta">@Nullable</span> Object source)</span> &#123;</span><br><span class="line"></span><br><span class="line">    Assert.notNull(registry, <span class="string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) &#123;</span><br><span class="line">        <span class="type">BeanDefinition</span> <span class="variable">apcDefinition</span> <span class="operator">=</span> registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);</span><br><span class="line">        <span class="keyword">if</span> (!cls.getName().equals(apcDefinition.getBeanClassName())) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">currentPriority</span> <span class="operator">=</span> findPriorityForClass(apcDefinition.getBeanClassName());</span><br><span class="line">            <span class="type">int</span> <span class="variable">requiredPriority</span> <span class="operator">=</span> findPriorityForClass(cls);</span><br><span class="line">            <span class="keyword">if</span> (currentPriority &lt; requiredPriority) &#123;</span><br><span class="line">                apcDefinition.setBeanClassName(cls.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">RootBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(cls);</span><br><span class="line">    beanDefinition.setSource(source);</span><br><span class="line">    beanDefinition.getPropertyValues().add(<span class="string">&quot;order&quot;</span>, Ordered.HIGHEST_PRECEDENCE);</span><br><span class="line">    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition);</span><br><span class="line">    <span class="keyword">return</span> beanDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
查看registerOrEscalateApcAsRequired方法，可以了解到其内部做了相关的判断，如果注册中已经存在AnnotationAwareAspectJAutoProxyCreator，需要做一些判断，当初始化阶段没有创建这个组件的时候，这个方法需要去创建一个AnnotationAwareAspectJAutoProxyCreator的定义信息，<br>  RootBeanDefinition beanDefinition &#x3D; new RootBeanDefinition(cls);<br>创建完成之后这个Bean的定义名就是“internalAutoProxyCreator”，注册在registry中；<br>  registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition);</li>
</ul>
<p>这一套流程下来，总结发现，整个调用层级就是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@EnableAspectJAutoProxy</span><br><span class="line">   @Import(AspectJAutoProxyRegistrar.class)</span><br><span class="line">        ImportBeanDefinitionRegistrar</span><br></pre></td></tr></table></figure>
<p>最总的目的是给容器注册了一个叫AnnotationAwareAspectJAutoProxyCreator的组件。</p>
<h5 id="1-2-2、关于AnnotationAwareAspectJAutoProxyCreator"><a href="#1-2-2、关于AnnotationAwareAspectJAutoProxyCreator" class="headerlink" title="1.2.2、关于AnnotationAwareAspectJAutoProxyCreator"></a>1.2.2、关于AnnotationAwareAspectJAutoProxyCreator</h5><p>最主要的目的是探索这个组件实现什么功能：<br>查看这个组件的内部关系,可以看到这个组件继承了AspectJAwareAdvisorAutoProxyCreator类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnnotationAwareAspectJAutoProxyCreator</span> <span class="keyword">extends</span> <span class="title class_">AspectJAwareAdvisorAutoProxyCreator</span> </span><br></pre></td></tr></table></figure>
<p>查看AnnotationAwareAspectJAutoProxyCreator的层级关系</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1、AnnotationAwareAspectJAutoProxyCreator</span><br><span class="line">2、    extends AspectJAwareAdvisorAutoProxyCreator</span><br><span class="line">3、        extends AbstractAdvisorAutoProxyCreator</span><br><span class="line">4、            extends AbstractAutoProxyCreator</span><br><span class="line">5、                extends ProxyProcessorSupport implements SmartInstantiationAwareBeanPostProcessor, BeanFactoryAware </span><br><span class="line">6、                    extends ProxyConfig implements Ordered, BeanClassLoaderAware, AopInfrastructureBean</span><br></pre></td></tr></table></figure>
<p>可以看到在第5次继承父类的时候，还是implements SmartInstantiationAwareBeanPostProcessor, BeanFactoryAware，</p>
<p>查看SmartInstantiationAwareBeanPostProcessor的层级关系</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、SmartInstantiationAwareBeanPostProcessor</span><br><span class="line">2、    extends InstantiationAwareBeanPostProcessor</span><br><span class="line">3、        extends BeanPostProcessor</span><br></pre></td></tr></table></figure>
<p>SmartInstantiationAwareBeanPostProcessor是一个后置处理器，可以关注他在Bean创建前后发生的事情，同时也要分析BeanFactoryAware这个Bean的工厂类做的什么工作。<br>这里直接总结一个结论：<br>在容器启动的时候，通过使用@EnableAspectJAutoProxy注解，完成对AnnotationAwareAspectJAutoProxyCreator注册，因为具备了后置处理器的功能，当今后在创建Bean对象的时候，也会监控到整个创建过程。<br>目标方法的执行过程：<br>    容器中保存的组件的代理对象，dglib也就是增强之后的对象，这个对象中保存了详细信息，包括：增强器，目标对象<br>    <img src="/zhangyangibm/images/20210314/0042.png" alt="Aspect" title="Aspect"><br>    1、通过CglibAopProxy.intercept();拦截目标方法的执行<br>    2、根据ProxyFactory对象，获取目标方法拦截器链<br>        List<Object> chain &#x3D; this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass)<br>        <img src="/zhangyangibm/images/20210314/0043.png" alt="Aspect" title="Aspect"><br>        进一步查看这个获取过程，首先可以看到一个参数method，可以发现这个method就是正在执行的目标方法。<br>        在进入这个方法，<br>        <img src="/zhangyangibm/images/20210314/0044.png" alt="Aspect" title="Aspect"><br>        会看到处理了一些缓存相关的事件，还有advisorChainFactory工厂，通过工厂类获取目标方法的拦截器链，tgetInterceptorsAndDynamicInterceptionAdvice(this, method, targetClass)，如果获取到了拦截器链，就放入缓存中并return，如何获取这个拦截器链，在进入方法：<br>        <img src="/zhangyangibm/images/20210314/0045.png" alt="Aspect" title="Aspect"><br>        会看到一个interceptorList，作用是保存所有的拦截器，查看到有5个增强器<br>        <img src="/zhangyangibm/images/20210314/0046.png" alt="Aspect" title="Aspect"><br>        之后对增强器进行遍历，将其转为interceptorList<br>    3、如果这个拦截器链是空的，将会继续执行目标方法<br>        Object[] argsToUse &#x3D; AopProxyUtils.adaptArgumentsIfNecessary(method, args);<br>        拦截器链每一个通知方法又被包装为一个拦截器，利用MethodInterceptor机制<br>    4、如果存在拦截器链，将会创建一个CglibMethodInvocation,把目标对象、目标方法、连接器链等信息全部传入过去，并且调用proceed()方法，<br>        Object retVal;<br>        etVal &#x3D; new CglibMethodInvocation(proxy, target, method, args, targetClass, chain, methodProxy).proceed()<br>        下图可以看到chain方法是有拦截器链五个<br>        <img src="/zhangyangibm/images/20210314/0047.png" alt="Aspect" title="Aspect"><br>        <img src="/zhangyangibm/images/20210314/0048.png" alt="Aspect" title="Aspect"><br>        关于proceed()实现方法<br>        <img src="/zhangyangibm/images/20210314/0049.png" alt="Aspect" title="Aspect"><br>        这里有一个判断：<br>    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// We start with an index of -1 and increment early.</span><br><span class="line">if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1) &#123;</span><br><span class="line">    return invokeJoinpoint();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>        this.currentInterceptorIndex &#x3D;&#x3D; this.interceptorsAndDynamicMethodMatchers.size() - 1，其实就是说拦截器链是否为空（如果是空0-1&#x3D;-1），如果没有拦截器，就会执行invokeJoinpoint();方法，底层实现<br>        <img src="/zhangyangibm/images/20210314/0050.png" alt="Aspect" title="Aspect"><br>        如果判断条件不成立，将会执行：Object interceptorOrInterceptionAdvice &#x3D; this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex);获取出第0个位置的拦截器，<br>        <img src="/zhangyangibm/images/20210314/0051.png" alt="Aspect" title="Aspect"><br>        通过invoke(this)，调用mi.proceed();<br>        <img src="/zhangyangibm/images/20210314/0052.png" alt="Aspect" title="Aspect"><br>        诸如此类，每次执行一次currentInterceptorInde自增+1 ，直到全部拦截器获取完成,每一个拦截器等待下一个拦截器执行完成返回以后再来执行，这种链式模式也是“拦截器链”机制，以保证通知方和目标方的执行顺序：<br>        ➡️ExposeInvocationInterceptor<br>        ➡️AspectJAfterThrowingAdvice<br>        ➡️AfterReturningAdviceInterceptor<br>        ➡️AspectJAfterAdvice<br>        ➡️MethodBeforeAdviceInterceptor<br>        满足条件后最终执行return invokeJoinpoint() ，此时将会反向返回，<br>        ➡️MethodBeforeAdviceInterceptor<br>        ➡️AspectJAfterAdvice<br>        ➡️AfterReturningAdviceInterceptor<br>        ➡️AspectJAfterThrowingAdvice<br>        ➡️ExposeInvocationInterceptor<br>        正常情况下：调用前置通知（Before）➡️调用目标方法 ➡️调用后置通知（AspectJAfterAdvice）➡️调用完成通知（AfterReturningAdviceInterceptor）；<br>        异常情况中：调用前置通知（Before）➡️调用目标方法 ➡️调用后置通知（AspectJAfterAdvice）➡️调用后置通知（AfterReturningAdviceInterceptor）时抛出异常 ➡️调用（Throwing）执行（AspectJAfterThrowingAdvice）</p>
<h4 id="1-2-3、AOP面向切面总结："><a href="#1-2-3、AOP面向切面总结：" class="headerlink" title="1.2.3、AOP面向切面总结："></a>1.2.3、AOP面向切面总结：</h4><ul>
<li>使用@EnableAspectJAutoProxy注解开启Aop功能</li>
<li>使用@EnableAspectJAutoProxy给容器中注册一个组件AnnotationAwareAspectJAutoProxyCreator后置处理器</li>
<li>容器的创建流程：<br>➡️注册后置处理<br>➡️初始化单实例Bean<br>➡️创建业务逻辑组件和切面组件<br>➡️AnnotationAwareAspectJAutoProxyCreator拦截组件创建过程<br>➡️判断组件是否需要增强<br>➡️包装增强器（Advisor），<br>➡️给逻辑组件创建代理对象（CJLIB）</li>
<li>执行目标方法：CglibAopProxy.intercept()得到目标容器的拦截器链，利用链式机制，一次执行每一个拦截器一次执行，<br> 正常通知：前置通知➡️目标方法➡️后置通知➡️返回通知<br> 异常通知：前置通知➡️目标方法➡️后置通知➡️异常通知</li>
</ul>
<h3 id="2、事务（Transaction）"><a href="#2、事务（Transaction）" class="headerlink" title="2、事务（Transaction）"></a>2、事务（Transaction）</h3><h4 id="2-1、环境"><a href="#2-1、环境" class="headerlink" title="2.1、环境"></a>2.1、环境</h4><ul>
<li>1、在pom.xml中导入相关依赖:JDBC、数据源和驱动<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-orm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/c3p0/c3p0 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>2、配置数据源、JdbcTemplate（Spring提供的简化数据库操作的工具）操作数据库<br>首先需要新建一个数据库配置文件：dbconfig.properties配置基本信息<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.user=root</span><br><span class="line">db.password=111111</span><br><span class="line">db.DriverClass=com.mysql.jdbc.Driver</span><br></pre></td></tr></table></figure>
使用mysql在数据库中创建一张测试表<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `tb_user` (</span><br><span class="line">`id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">`username` varchar(20) DEFAULT NULL,</span><br><span class="line">`age` int(3) DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">SET FOREIGN_KEY_CHECKS = 1;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<img src="/zhangyangibm/images/20210314/0053.png" alt="Transaction" title="Transaction"><br>插入一则数据<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `tb_user` (username, age)</span><br><span class="line">VALUES</span><br><span class="line">	(&quot;Zhangsan&quot;, 29);</span><br></pre></td></tr></table></figure>
<img src="/zhangyangibm/images/20210314/0054.png" alt="Transaction" title="Transaction"></li>
</ul>
<p>场景1，使用Spring代码动态的往数据库中insert一则数据<br>新建一个Dao，UserDao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;INSERT INTO `tb_user` (username, age) VALUES (?, ?)&quot;</span>;</span><br><span class="line">		<span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> UUID.randomUUID().toString().substring(<span class="number">1</span>,<span class="number">6</span>);</span><br><span class="line">		jdbcTemplate.update(sql,username,<span class="number">20</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建一个Service，UserService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDao userDao;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">()</span> &#123;</span><br><span class="line">		userDao.insert();</span><br><span class="line">		System.out.println(<span class="string">&quot;tb_user 插入完成......&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>文件配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PropertySource(value=&#123;&quot;classpath:/dbconfig.properties&quot;&#125;)</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.zhy.Transaction&quot;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;db.user&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String username;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;db.password&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String pwd;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;db.DriverClass&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String driverClass;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> <span class="keyword">throws</span> PropertyVetoException &#123;</span><br><span class="line">		<span class="type">ComboPooledDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComboPooledDataSource</span>();</span><br><span class="line">		dataSource.setUser(username);</span><br><span class="line">		dataSource.setPassword(pwd);</span><br><span class="line">		dataSource.setJdbcUrl(<span class="string">&quot;jdbc:mysql://192.xxx.x.xxx:3306/mango&quot;</span>);</span><br><span class="line">		dataSource.setDriverClass(driverClass);	</span><br><span class="line">		<span class="keyword">return</span> dataSource;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> PropertyVetoException </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> JdbcTemplate <span class="title function_">jdbcTemplate</span><span class="params">()</span> <span class="keyword">throws</span> PropertyVetoException &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//dataSource() 是从Spring容器中获取组件，这个是Spring容器对config文件的特殊处理</span></span><br><span class="line">		<span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>(dataSource());</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionTest</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// 创建IoC容器</span></span><br><span class="line">		<span class="type">AnnotationConfigApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(</span><br><span class="line">				TransactionConfig.class);</span><br><span class="line">		</span><br><span class="line">		<span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> applicationContext.getBean(UserService.class);</span><br><span class="line">		userService.insertUser();</span><br><span class="line"></span><br><span class="line">		applicationContext.close();</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：<br><img src="/zhangyangibm/images/20210314/0055.png" alt="Transaction" title="Transaction"><br><img src="/zhangyangibm/images/20210314/0056.png" alt="Transaction" title="Transaction"></p>
<h4 id="2-2、-Transactional注解"><a href="#2-2、-Transactional注解" class="headerlink" title="2.2、@Transactional注解"></a>2.2、@Transactional注解</h4><p>场景2:上边的程序如果在运行期间发现错误，当前的的这个数据就不应该Insert成功，这个时候需要事务进行处理，这个时候要是用到 <strong>@Transactional</strong> 注解，如以下，在程序运行过程中设定一个运算错误：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserDao userDao;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Transactional</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;tb_user 插入开始......&quot;</span>);</span><br><span class="line">		userDao.insert();</span><br><span class="line">		</span><br><span class="line">		<span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">10</span>/<span class="number">0</span>;</span><br><span class="line">		System.out.println(<span class="string">&quot;tb_user 插入完成......&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/images/20210314/0057.png" alt="Transaction" title="Transaction"><br>但是数据库中的记录依旧插入成功，说明注解失败<br><img src="/zhangyangibm/images/20210314/0058.png" alt="Transaction" title="Transaction"></p>
<h4 id="2-3、-EnableTransactionManagement注解"><a href="#2-3、-EnableTransactionManagement注解" class="headerlink" title="2.3、@EnableTransactionManagement注解"></a>2.3、@EnableTransactionManagement注解</h4><p>解决上边的问题需要另一个配置 <strong>@EnableTransactionManagement</strong> 注解，告知spring需要开启注解事务功能 PlatformTransactionManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@PropertySource(value=&#123;&quot;classpath:/dbconfig.properties&quot;&#125;)</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.zhy.Transaction&quot;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;db.user&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String username;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;db.password&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String pwd;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;db.DriverClass&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String driverClass;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> <span class="keyword">throws</span> PropertyVetoException &#123;</span><br><span class="line">		<span class="type">ComboPooledDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComboPooledDataSource</span>();</span><br><span class="line">		dataSource.setUser(username);</span><br><span class="line">		dataSource.setPassword(pwd);</span><br><span class="line">		dataSource.setJdbcUrl(<span class="string">&quot;jdbc:mysql://192.168.0.105:3306/mango&quot;</span>);</span><br><span class="line">		dataSource.setDriverClass(driverClass);	</span><br><span class="line">		<span class="keyword">return</span> dataSource;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> PropertyVetoException </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> JdbcTemplate <span class="title function_">jdbcTemplate</span><span class="params">()</span> <span class="keyword">throws</span> PropertyVetoException &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//dataSource() 是从Spring容器中获取组件，这个是Spring容器对config文件的特殊处理</span></span><br><span class="line">		<span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>(dataSource());</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动测试发现，inser开始的语句没有打印成功，说明方法执行失败，这是因为没有配置事务管理器管理事务，<br><img src="/zhangyangibm/images/20210314/0059.png" alt="Transaction" title="Transaction"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@PropertySource(value=&#123;&quot;classpath:/dbconfig.properties&quot;&#125;)</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.zhy.Transaction&quot;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;db.user&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String username;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;db.password&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String pwd;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;db.DriverClass&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String driverClass;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> <span class="keyword">throws</span> PropertyVetoException &#123;</span><br><span class="line">		<span class="type">ComboPooledDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComboPooledDataSource</span>();</span><br><span class="line">		dataSource.setUser(username);</span><br><span class="line">		dataSource.setPassword(pwd);</span><br><span class="line">		dataSource.setJdbcUrl(<span class="string">&quot;jdbc:mysql://192.168.0.105:3306/mango&quot;</span>);</span><br><span class="line">		dataSource.setDriverClass(driverClass);	</span><br><span class="line">		<span class="keyword">return</span> dataSource;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> PropertyVetoException </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> JdbcTemplate <span class="title function_">jdbcTemplate</span><span class="params">()</span> <span class="keyword">throws</span> PropertyVetoException &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//dataSource() 是从Spring容器中获取组件，这个是Spring容器对config文件的特殊处理</span></span><br><span class="line">		<span class="type">JdbcTemplate</span> <span class="variable">jdbcTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>(dataSource());</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> jdbcTemplate;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 注册事务管理器</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> PropertyVetoException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> PlatformTransactionManager <span class="title function_">platformTransactionManager</span><span class="params">()</span> <span class="keyword">throws</span> PropertyVetoException &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(dataSource());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>启动测试：说明结果正确异常显示正确，数据库没有insert数据，说明成功！<br><img src="/zhangyangibm/images/20210314/0060.png" alt="Transaction" title="Transaction"><br><img src="/zhangyangibm/images/20210314/0061.png" alt="Transaction" title="Transaction"></p>
<h4 id="2-3、功能实现总结"><a href="#2-3、功能实现总结" class="headerlink" title="2.3、功能实现总结"></a>2.3、功能实现总结</h4><p>结合上边的事例 可以将Spring的事务管理实现方法进行总结：</p>
<ul>
<li>需要在pom.xml文件中导入相关的依赖，数据源（c3p0），数据库驱动（mysql），Spring-jdbc模块，spring-orm模块；</li>
<li>配置数据源，JdbcTemplate操作数据库；</li>
<li>给config文件标记@Transactional注解，告知Spring容器这是一个事务；</li>
<li>给config文件标记添加注解@EnableTransactionManagement，实现基于此注解的事务管理功能；</li>
<li>配置事务管理器（PlatformTransactionManager）实现对事务的控制。<br>public PlatformTransactionManager platformTransactionManager() throws PropertyVetoException</li>
</ul>
<h4 id="2-4、事务声明的分析"><a href="#2-4、事务声明的分析" class="headerlink" title="2.4、事务声明的分析"></a>2.4、事务声明的分析</h4><p>通过功能总结可以发现 注解 <strong>@EnableTransactionManagement</strong> 在其中起到了至关重要的作用，分析从这个注解入手。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@PropertySource(value=&#123;&quot;classpath:/dbconfig.properties&quot;&#125;)</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.zhy.Transaction&quot;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@EnableTransactionManagement的源码实现上也存在一个@Import(TransactionManagementConfigurationSelector.class)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(TransactionManagementConfigurationSelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableTransactionManagement &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现继承层级结构：<br>@EnableTransactionManagement<br>    @Import(TransactionManagementConfigurationSelector.class)<br>        extends AdviceModeImportSelector<br>            implements ImportSelector</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Selects which implementation of &#123;<span class="doctag">@link</span> AbstractTransactionManagementConfiguration&#125;</span></span><br><span class="line"><span class="comment"> * should be used based on the value of &#123;<span class="doctag">@link</span> EnableTransactionManagement#mode&#125; on the</span></span><br><span class="line"><span class="comment"> * importing &#123;<span class="doctag">@code</span> <span class="doctag">@Configuration</span>&#125; class.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Chris Beams</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Juergen Hoeller</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableTransactionManagement</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ProxyTransactionManagementConfiguration</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> TransactionManagementConfigUtils#TRANSACTION_ASPECT_CONFIGURATION_CLASS_NAME</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> TransactionManagementConfigUtils#JTA_TRANSACTION_ASPECT_CONFIGURATION_CLASS_NAME</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionManagementConfigurationSelector</span> <span class="keyword">extends</span> <span class="title class_">AdviceModeImportSelector</span>&lt;EnableTransactionManagement&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns &#123;<span class="doctag">@link</span> ProxyTransactionManagementConfiguration&#125; or</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@code</span> AspectJ(Jta)TransactionManagementConfiguration&#125; for &#123;<span class="doctag">@code</span> PROXY&#125;</span></span><br><span class="line"><span class="comment">	 * and &#123;<span class="doctag">@code</span> ASPECTJ&#125; values of &#123;<span class="doctag">@link</span> EnableTransactionManagement#mode()&#125;,</span></span><br><span class="line"><span class="comment">	 * respectively.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> String[] selectImports(AdviceMode adviceMode) &#123;</span><br><span class="line">		<span class="keyword">switch</span> (adviceMode) &#123;</span><br><span class="line">			<span class="keyword">case</span> PROXY:</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;AutoProxyRegistrar.class.getName(),</span><br><span class="line">						ProxyTransactionManagementConfiguration.class.getName()&#125;;</span><br><span class="line">			<span class="keyword">case</span> ASPECTJ:</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;determineTransactionAspectClass()&#125;;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String <span class="title function_">determineTransactionAspectClass</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (ClassUtils.isPresent(<span class="string">&quot;javax.transaction.Transactional&quot;</span>, getClass().getClassLoader()) ?</span><br><span class="line">				TransactionManagementConfigUtils.JTA_TRANSACTION_ASPECT_CONFIGURATION_CLASS_NAME :</span><br><span class="line">				TransactionManagementConfigUtils.TRANSACTION_ASPECT_CONFIGURATION_CLASS_NAME);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"> ```          </span><br><span class="line">在TransactionManagementConfigurationSelector中selectImports方法首先判断adviceMode，</span><br><span class="line">如果是PROXY就要返回一个String数组，这个数组中包含了 AutoProxyRegistrar和ProxyTransactionManagementConfiguration组件相关信息，</span><br><span class="line">如果是 ASPECTJ也要返回一个String数组，</span><br><span class="line">AdviceMode是一个枚举类，在这里它定义在EnableTransactionManagement注解中,定义默认PROXY</span><br><span class="line">![Transaction](/images/<span class="number">20210314</span>/<span class="number">0062.</span>png <span class="string">&quot;Transaction&quot;</span>)</span><br><span class="line">也就是只需要关注两个组件：</span><br><span class="line">AutoProxyRegistrar：</span><br><span class="line">ProxyTransactionManagementConfiguration：</span><br><span class="line"></span><br><span class="line">* AutoProxyRegistrar</span><br><span class="line">进入到源码可以看到这个组件中包含一个方法：registerBeanDefinitions</span><br><span class="line">![Transaction](/images/<span class="number">20210314</span>/<span class="number">0063.</span>png <span class="string">&quot;Transaction&quot;</span>)</span><br><span class="line">通过这个逻辑，如果<span class="keyword">if</span> (mode == AdviceMode.PROXY) 的情况将会执行AopConfigUtils.registerAutoProxyCreatorIfNecessary(registry)，下边的proxyTargetClass在EnableTransactionManagement注解中已经定义并且默认为“<span class="literal">false</span>”，所以这里执行的只有“AopConfigUtils.registerAutoProxyCreatorIfNecessary(registry)”方法</span><br><span class="line">![Transaction](/images/<span class="number">20210314</span>/<span class="number">0064.</span>png <span class="string">&quot;Transaction&quot;</span>)</span><br><span class="line">进入registerAutoProxyCreatorIfNecessary</span><br><span class="line">![Transaction](/images/<span class="number">20210314</span>/<span class="number">0065.</span>png <span class="string">&quot;Transaction&quot;</span>)</span><br><span class="line">最终AutoProxyRegistrar给容器中注册了InfrastructureAdvisorAutoProxyCreator组件，这个组件是后置处理器：</span><br><span class="line">利用后置处理器机制，在对象创建完成之后，包装对象在返回一个代理对象，代理对象中包含了增强器，代理对象执行方法利用拦截器来实现功能。</span><br><span class="line"></span><br><span class="line">* ProxyTransactionManagementConfiguration：</span><br><span class="line">![Transaction](/images/<span class="number">20210314</span>/<span class="number">0066.</span>png <span class="string">&quot;Transaction&quot;</span>)</span><br><span class="line"><span class="number">1</span>、给容器中注册了事务增强器：</span><br><span class="line">事务增强器要用事务注解的信息，通过AnnotationTransactionAttributeSource解析注解<span class="meta">@Transactional</span>的内部信息</span><br><span class="line"><span class="number">2</span>、给容器中注册了事务拦截器：</span><br><span class="line">TransactionInterceptor，保存了事务属性信息和事务管理器</span><br><span class="line"> ➡️ <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> 这是一个方法拦截器,</span><br><span class="line">TransactionInterceptor有一个invoke方法，进入invokeWithinTransaction</span><br><span class="line">```java</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// Work out the target class: may be &#123;@code null&#125;.</span></span><br><span class="line">    <span class="comment">// The TransactionAttributeSource should be passed the target class</span></span><br><span class="line">    <span class="comment">// as well as the method, which may be from an interface.</span></span><br><span class="line">    Class&lt;?&gt; targetClass = (invocation.getThis() != <span class="literal">null</span> ? AopUtils.getTargetClass(invocation.getThis()) : <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Adapt to TransactionAspectSupport&#x27;s invokeWithinTransaction...</span></span><br><span class="line">    <span class="keyword">return</span> invokeWithinTransaction(invocation.getMethod(), targetClass, invocation::proceed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 在目标方法执行的时候<br>    ➡️会执行拦截器链：<br>    ➡️执行事务拦截器：<br>        先执行事务相关属性<br>        在获取平台的事务管理器PlatformTransactionManager，如果事先没有添加任何transactionManager，最总会从容器中按照类型获取一个PlatformTransactionManager<br>    ➡️执行目标方法，<br>        如果异常，利用事务管理器回滚操作<br>        如果正常，利用事务管理器提交操作</p>
<h3 id="前言-2"><a href="#前言-2" class="headerlink" title="前言"></a>前言</h3><p>Spring的扩展原理，对Spring的内容补充和扩展，也是一种辅助性的功能</p>
<h3 id="1、Spring的扩展原理"><a href="#1、Spring的扩展原理" class="headerlink" title="1、Spring的扩展原理"></a>1、Spring的扩展原理</h3><h4 id="1-1、BeanFactoryPostProcessor接口"><a href="#1-1、BeanFactoryPostProcessor接口" class="headerlink" title="1.1、BeanFactoryPostProcessor接口"></a>1.1、BeanFactoryPostProcessor接口</h4><p>之前介绍了一个后置处理器：BeanPostProcessor后置处理器，BeanFactoryPostProcessor与其相比有以下差异：<br>BeanPostProcessor：Bean的后置处理器，Bean初始化前后进行拦截工作<br>BeanFactoryPostProcessor：BeanFactory的后置处理器，在BeanFactory标准初始化完了之后调用，所有的Bean定义已经保存加载到BeanFactory，但是Bean的实例还没有创建</p>
<p>模拟环境：<br>创建一个配置类：ExtConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ComponentScan(&quot;com.zhy.ext&quot;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExtConfig</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> Tools1 <span class="title function_">tools1</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Tools1</span>();</span><br><span class="line">	&#125;;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> Tools2 <span class="title function_">tools2</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Tools2</span>();</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.out.println(<span class="string">&quot;MyBeanFactoryPostProcessor....postProcessBeanFactory&quot;</span>);</span><br><span class="line">		<span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> beanFactory.getBeanDefinitionCount();</span><br><span class="line">		System.out.println(<span class="string">&quot;当前的Bean有&quot;</span> + count + <span class="string">&quot;个&quot;</span>);</span><br><span class="line">		String[] names = beanFactory.getBeanDefinitionNames();</span><br><span class="line">		System.out.println(<span class="string">&quot;Bean Name&quot;</span> + Arrays.asList(names));</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IOCTest_Ext</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">//1.创建IoC容器</span></span><br><span class="line">		<span class="type">AnnotationConfigApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(</span><br><span class="line">				MyBeanFactoryPostProcessor.class);</span><br><span class="line">		System.out.println(<span class="string">&quot;容器创建完成......&quot;</span>);</span><br><span class="line">		<span class="comment">//2.管理容器，对象销毁</span></span><br><span class="line">		applicationContext.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/spring/0067.png" alt="Eclipse" title="Eclipse"><br>IOC容器创建对象之前，从打印日志中可以看出，<br>在执行Tools的bean初始化之前 BeanFactory先执行。也就是说在初始化其他组件之前，BeanFactory先执行。</p>
<h4 id="1-2、BeanDefinitionRegistryPostProcessor"><a href="#1-2、BeanDefinitionRegistryPostProcessor" class="headerlink" title="1.2、BeanDefinitionRegistryPostProcessor"></a>1.2、BeanDefinitionRegistryPostProcessor</h4><p>接下来要关注ta的一个子接口：BeanDefinitionRegistryPostProcessor<br><img src="/zhangyangibm/spring/0068.png" alt="Eclipse" title="Eclipse"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanDefinitionRegistryPostProcessor</span> <span class="keyword">extends</span> <span class="title class_">BeanFactoryPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Modify the application context&#x27;s internal bean definition registry after its</span></span><br><span class="line"><span class="comment">	 * standard initialization. All regular bean definitions will have been loaded,</span></span><br><span class="line"><span class="comment">	 * but no beans will have been instantiated yet. This allows for adding further</span></span><br><span class="line"><span class="comment">	 * bean definitions before the next post-processing phase kicks in.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> registry the bean definition registry used by the application context</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> org.springframework.beans.BeansException in case of errors</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中包含了一个方法：postProcessBeanDefinitionRegistry<br>在所有bean定义信息将要被加载，但是Bean的实例还没有在创建之前</p>
<p>继承之后有两个方法，分别来源于BeanFactoryPostProcessor和BeanDefinitionRegistryPostProcessor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyPostProcessBeanDefinitionRegistry</span> <span class="keyword">implements</span> <span class="title class_">BeanDefinitionRegistryPostProcessor</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhangyang</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyPostProcessBeanDefinitionRegistry</span> <span class="keyword">implements</span> <span class="title class_">BeanDefinitionRegistryPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.out.println(<span class="string">&quot;postProcessBeanFactory....bean count &quot;</span> + beanFactory.getBeanDefinitionCount());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * BeanDefinitionRegistry</span></span><br><span class="line"><span class="comment">	 * Bean定义信息的存储中心，以后的BeanFactory就是按照BeanDefinitionRegistry里边保存的每一个Bean定义信息创建Bean的实例</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.out.println(<span class="string">&quot;postProcessBeanDefinitionRegistry....bean count &quot;</span> + registry.getBeanDefinitionCount());</span><br><span class="line">        <span class="comment">//注册一个新的Bean，HelloBean</span></span><br><span class="line">		<span class="type">RootBeanDefinition</span> <span class="variable">rootBeanDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(Tools3.class);</span><br><span class="line">		registry.registerBeanDefinition(<span class="string">&quot;HelloBean&quot;</span>, rootBeanDefinition);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动测试：<br><img src="/zhangyangibm/spring/0069.png" alt="Eclipse" title="Eclipse"></p>
<p>观察以下执行顺序：</p>
<ul>
<li>1、BeanDefinitionRegistryPostProcessor 执行<br>打印：postProcessBeanDefinitionRegistry….bean count 10<br>注册一个Tools3实例，容器中实例个数 11</li>
<li>2、 postProcessBeanFactory<br>打印：postProcessBeanFactory….bean count 11</li>
<li>3、MyBeanFactoryPostProcessor<br>打印：➡️MyBeanFactoryPostProcessor….postProcessBeanFactory<br>   ➡️当前的BeanFactory有11个<br>   ➡️Bean Name[org.springframework.context.annotation.internalConfigurationAnnotationProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor, org.springframework.context.event.internalEventListenerProcessor, org.springframework.context.event.internalEventListenerFactory, extConfig, myBeanFactoryPostProcessor, myPostProcessBeanDefinitionRegistry, tools1, tools2, HelloBean]</li>
<li>4、Bean注解创建实例：<br>打印：当前bean的名字…tools1</li>
</ul>
<p>通关观察发现：<br>BeanDefinitionRegistryPostProcessor&gt;BeanFactoryPostProcessor,利用BeanDefinitionRegistryPostProcessor给容器中再额外注册一些组件；</p>
<p>源码：通过断点，查看源码查看运行：<br>程序起点应该在：启动IOC容器<br><img src="/zhangyangibm/spring/0071.png" alt="Eclipse" title="Eclipse"><br>看到执行BeanDefinitionRegistryPostProcessor.postProcessBeanDefinitionRegistry方法<br><img src="/zhangyangibm/spring/0070.png" alt="Eclipse" title="Eclipse"><br>只从invoke（）刷新<br><img src="/zhangyangibm/spring/0072.png" alt="Eclipse" title="Eclipse"><br>调用invoke（）的invokeBeanFactoryPostProcessors方法<br><img src="/zhangyangibm/spring/0073.png" alt="Eclipse" title="Eclipse"><br>先从容器中获取到所有的BeanDefinitionRegistryPostProcessor组件，其内部<br><img src="/zhangyangibm/spring/0074.png" alt="Eclipse" title="Eclipse"><br>依次触发所有的postProcessBeanDefinitionRegistry<br><img src="/zhangyangibm/spring/0075.png" alt="Eclipse" title="Eclipse"><br>BeanDefinitionRegistryPostProcessor组件执行完毕后，执行invokeBeanFactoryPostProcessors<br><img src="/zhangyangibm/spring/0076.png" alt="Eclipse" title="Eclipse"><br>查看其内部执行：BeanFactoryPostProcessor<br><img src="/zhangyangibm/spring/0077.png" alt="Eclipse" title="Eclipse"><br>在BeanDefinitionRegistryPostProcessor方法的后边还会执行invokeBeanFactoryPostProcessors，该方法执行的是后来实现的方法比如“MyBeanFactoryPostProcessor”<br><img src="/zhangyangibm/spring/0078.png" alt="Eclipse" title="Eclipse"><br>查看此方法，内部执行BeanFactoryPostProcessor<br><img src="/zhangyangibm/spring/0079.png" alt="Eclipse" title="Eclipse"><br>也就是说，先之前框架内部的，再从容器中找到BeanFactoryPostProcessor组件然后依次触发postProcessBeanFactory（）方法</p>
<h4 id="1-3、ApplicationListener-监听器"><a href="#1-3、ApplicationListener-监听器" class="headerlink" title="1.3、ApplicationListener 监听器"></a>1.3、ApplicationListener 监听器</h4><p>作用是监听容器中发布的事件，事件驱动模型开发。</p>
<p>1、实现方式一：查看ApplicationListener，会发现这是一个接口<br>@FunctionalInterface<br>public interface ApplicationListener<E extends ApplicationEvent> extends EventListener</p>
<p>也就是说如果想要实现监听功能需要实现：pplicationListener接口，当容器中发布此事件以后方法触发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApplicationListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ApplicationEvent&gt;&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//当容器中发布此事件以后方法触发</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>案例，查看容器中的收到事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApplicationListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ApplicationEvent&gt;&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.out.println(<span class="string">&quot;容器中收到的事件....&quot;</span>+event);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动查看结果：<br><img src="/zhangyangibm/spring/0080.png" alt="Eclipse" title="Eclipse"><br>说明容器刷新完成（所有的Bean创建完成）：org.springframework.context.event.ContextRefreshedEvent<br>说明容器关闭：org.springframework.context.event.ContextClosedEvent</p>
<p>基于事件开发步骤：</p>
<ul>
<li>创建监听器：</li>
<li>把监听器加入容器</li>
<li>监听容器，只要有相关事件发布，就会被监听</li>
</ul>
<p>自定义事件发布：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IOCTest_Ext</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">//1.创建IoC容器</span></span><br><span class="line">		<span class="type">AnnotationConfigApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(</span><br><span class="line">				ExtConfig.class);</span><br><span class="line">		applicationContext.publishEvent(<span class="keyword">new</span> <span class="title class_">ApplicationEvent</span>(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;自定义事件发布&quot;</span>)) &#123;</span><br><span class="line">			</span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="comment">//2.管理容器，对象销毁</span></span><br><span class="line">		applicationContext.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/spring/0081.png" alt="ApplicationListener" title="ApplicationListener"></p>
<p>2、实现方式二：**@EventListener** 注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExtService</span> &#123;</span><br><span class="line">	 </span><br><span class="line">	<span class="meta">@EventListener(classes= &#123;ApplicationEvent.class&#125;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Listen</span><span class="params">(ApplicationEvent applicationEvent)</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;注解...ExtService...&quot;</span>+applicationEvent);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/spring/0082.png" alt="ApplicationListener" title="ApplicationListener"></p>
<p>@EventListener的原理：<br>使用EventListenerMethodProcessor处理器解析方法上的@EventListener注解，查看EventListenerMethodProcessor发现实现了接口：<br>implements SmartInitializingSingleton, ApplicationContextAware, BeanFactoryPostProcessor，其中SmartInitializingSingleton这个接口最主要，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SmartInitializingSingleton</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Invoked right at the end of the singleton pre-instantiation phase,</span></span><br><span class="line"><span class="comment">	 当单实例bean创建完成之后</span></span><br><span class="line"><span class="comment">	 * with a guarantee that all regular singleton beans have been created</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * already. &#123;<span class="doctag">@link</span> ListableBeanFactory#getBeansOfType&#125; calls within</span></span><br><span class="line"><span class="comment">	 * this method won&#x27;t trigger accidental side effects during bootstrap.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;&lt;b&gt;<span class="doctag">NOTE:</span>&lt;/b&gt; This callback won&#x27;t be triggered for singleton beans</span></span><br><span class="line"><span class="comment">	 * lazily initialized on demand after &#123;<span class="doctag">@link</span> BeanFactory&#125; bootstrap,</span></span><br><span class="line"><span class="comment">	 * and not for any other bean scope either. Carefully use it for beans</span></span><br><span class="line"><span class="comment">	 * with the intended bootstrap semantics only.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">afterSingletonsInstantiated</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1、首先IOC容器开始创建对象，调用refresh();刷新容器<br>2、finishBeanFactoryInitialization初始化剩下的单实例Bean<br>3、继续初始化所有的单实例bean<br>&#x2F;&#x2F; Instantiate all remaining (non-lazy-init) singletons.<br>beanFactory.preInstantiateSingletons();<br>4、smartSingleton.afterSingletonsInstantiated();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Trigger post-initialization callback for all applicable beans...</span></span><br><span class="line">		<span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">			<span class="type">Object</span> <span class="variable">singletonInstance</span> <span class="operator">=</span> getSingleton(beanName);</span><br><span class="line">			<span class="keyword">if</span> (singletonInstance <span class="keyword">instanceof</span> SmartInitializingSingleton) &#123;</span><br><span class="line">				<span class="keyword">final</span> <span class="type">SmartInitializingSingleton</span> <span class="variable">smartSingleton</span> <span class="operator">=</span> (SmartInitializingSingleton) singletonInstance;</span><br><span class="line">				<span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span>) &#123;</span><br><span class="line">					AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">						smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">						<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">					&#125;, getAccessControlContext());</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>分析方法的调用时机<br>    先创建所有的单实例Bean，之后遍历所有的单实例Bean，<br>    判断if (singletonInstance instanceof SmartInitializingSingleton)是否实现了SmartInitializingSingleton接口，如果是就调用：smartSingleton.afterSingletonsInstantiated();</p>
<h4 id="1-4、Spring源码的实现流程"><a href="#1-4、Spring源码的实现流程" class="headerlink" title="1.4、Spring源码的实现流程"></a>1.4、Spring源码的实现流程</h4><p>Sprint容器起始点就是从创建Spring容器开始new AnnotationConfigApplicationContext();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IOCTest_Ext</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Test01</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">//1.创建IoC容器</span></span><br><span class="line">		<span class="type">AnnotationConfigApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(</span><br><span class="line">				ExtConfig.class);</span><br><span class="line">		applicationContext.publishEvent(<span class="keyword">new</span> <span class="title class_">ApplicationEvent</span>(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;自定义事件发布&quot;</span>)) &#123;</span><br><span class="line">			</span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="comment">//2.管理容器，对象销毁</span></span><br><span class="line">		applicationContext.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看这个方法,内部调用了刷新方法：refresh()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Create a new AnnotationConfigApplicationContext, deriving bean definitions</span></span><br><span class="line"><span class="comment">	* from the given component classes and automatically refreshing the context.</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@param</span> componentClasses one or more component classes &amp;mdash; for example,</span></span><br><span class="line"><span class="comment">	* &#123;<span class="doctag">@link</span> Configuration <span class="doctag">@Configuration</span>&#125; classes</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AnnotationConfigApplicationContext</span><span class="params">(Class&lt;?&gt;... componentClasses)</span> &#123;</span><br><span class="line">	<span class="built_in">this</span>();</span><br><span class="line">	register(componentClasses);</span><br><span class="line">	refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看一下这个方法的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">			<span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">			prepareRefresh();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">			<span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">			prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">				postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">				invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">				registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Initialize message source for this context.</span></span><br><span class="line">				initMessageSource();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">				initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">				onRefresh();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">				registerListeners();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">				finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">				finishRefresh();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">					logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">							<span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">				destroyBeans();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">				cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Propagate exception to caller.</span></span><br><span class="line">				<span class="keyword">throw</span> ex;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">finally</span> &#123;</span><br><span class="line">				<span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">				<span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">				resetCommonCaches();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>1、prepareRefresh();刷新前的预处理<br><img src="/zhangyangibm/spring/0083.png" alt="ApplicationListener" title="ApplicationListener"></p>
<ul>
<li>prepareRefresh() 初始化属性设置，自定义个性化属性设置方法</li>
<li>getEnvironment().validateRequiredProperties();属性的校验，检验属性合法性</li>
<li>this.earlyApplicationEvents &#x3D; new LinkedHashSet&lt;&gt;();保存容器中的事件<br>2、obtainFreshBeanFactory();获取Bean工厂<br><img src="/zhangyangibm/spring/0084.png" alt="ApplicationListener" title="ApplicationListener"></li>
<li>refreshBeanFactory();刷新Bean工厂<br>  ➡️ 创建一个this.beanFactory &#x3D; new DefaultListableBeanFactory();</li>
<li>获取Bean工厂getBeanFactory();并返回【ConfigurableListableBeanFactory】<br>3、prepareBeanFactory(beanFactory);BeanFactory预设置<br><img src="/zhangyangibm/spring/0085.png" alt="ApplicationListener" title="ApplicationListener"><br>4、postProcessBeanFactory(beanFactory);BeanFactory准备工作完成</li>
</ul>
<p>— 以上是BeanFactory的创建和与准备工作 —<br>5、pinvokeBeanFactoryPostProcessors(beanFactory);在BeanFactory标准初始化完成之后执行后置处理器<br>    ➡️ 执行BeanFactoryPostProcessor的方法<br>6、registerBeanPostProcessors(beanFactory);注册Bean的后置处理器<br>    ➡️ 执行BeanPostProcessor的方法<br>7、initMessageSource();初始化MessageSource组件（国际化功能，消息绑定和消息解析）<br><img src="/zhangyangibm/spring/0086.png" alt="ApplicationListener" title="ApplicationListener"><br>8、initApplicationEventMulticaster();初始化事件配发起，基于事件开发的组件<br>9、onRefresh();子类重写这个方法，在容器刷新的时候可以自定义逻辑<br>10、registerListeners();给容器中将所有项目里边的ApplicationListener注册进来<br>11、finishBeanFactoryInitialization(beanFactory);初始化剩下的单实例Bean<br>    ➡️ beanFactory.preInstantiateSingletons();<br>12、finishRefresh();完成BeanFactory的初始化创建工作；IOC容器就创建完成。</p>
<hr>
<p>总结：</p>
<ul>
<li>Spring启动的时候，会保存所有注册进来的Bean的定义信息（xml和注解）</li>
<li>Spring容器会创建这些Bean<br>  （1）、使用到Bean的时候，getBean创建Bean，常见好保存在容器中<br>  （2）、统一创建所有Bean的时候</li>
<li>后置处理器：<br>  每一个Bean创建完成都会使用后置处理器，增强Bean的功能</li>
<li>事件驱动模型</li>
</ul>
<hr>
<h3 id="2、SpringWeb"><a href="#2、SpringWeb" class="headerlink" title="2、SpringWeb"></a>2、SpringWeb</h3><p>基于servLet3.0开发需要Tomcat7以及以上版本作为支持，servLet3.0本身属于JSR315的规范，<br><img src="/zhangyangibm/spring/0089.png" alt="servLet" title="servLet"><br>可以在 <a target="_blank" rel="noopener" href="https://www.jcp.org/en/home/index">JCP的官网</a> 查询文档 servlet-3_0-mrel-spec.pdf<br><img src="/zhangyangibm/spring/0087.png" alt="servLet" title="servLet"><br><img src="/zhangyangibm/spring/0088.png" alt="servLet" title="servLet"></p>
<p>环境准备，创建一个web工程,导入两个jar servlet-api.jar 和 jsp-api.jar<br>完成包和类的创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhy.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="comment">//super.doGet(req, resp);</span></span><br><span class="line">		resp.getWriter().write(<span class="string">&quot;hello....&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写一个简单的html页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Insert title here<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;hello&quot;</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/spring/0090.png" alt="servLet" title="servLet"><br><img src="/zhangyangibm/spring/0091.png" alt="servLet" title="servLet"></p>
<p>配置启动程序，浏览器访问可以实现，页面文字显示<br><img src="/zhangyangibm/spring/0092.png" alt="servLet" title="servLet"><br><img src="/zhangyangibm/spring/0093.png" alt="servLet" title="servLet"></p>
<h4 id="2-1-Shared-libraries-x2F-runtimes-pluggability"><a href="#2-1-Shared-libraries-x2F-runtimes-pluggability" class="headerlink" title="2.1 Shared libraries &#x2F; runtimes pluggability"></a>2.1 Shared libraries &#x2F; runtimes pluggability</h4><p>这个部分的内容主要体现在servlet-3_0-mrel-spec.pdf文档中的8.2.4部分<br>Shared libraries &#x2F; runtimes pluggability 翻译为“共享库”和“运行时插件能力”<br><img src="/zhangyangibm/spring/0094.png" alt="servLet" title="servLet"></p>
<p>1、在servlet容器启动的时扫描，当前应用内每一个jar包的ServletContainerInitializer的实现<br>2、提供ServletContainerInitializer的实现类，必须绑定在META-INF&#x2F;services文件夹下的javax.servlet.ServletContainerInitializer，文件的内容就是ServletContainerInitializer实现类的全名。<br>也就是说：Servlet容器在启动应用的时候，会扫描当前应用的每一个jar包里边的 META-INF&#x2F;services&#x2F;javax.servlet.ServletContainerInitializer  指定的实现类，启动并运行这个实现类,按照文档所说，搭建环境：</p>
<p><img src="/zhangyangibm/spring/0095.png" alt="servLet" title="servLet"></p>
<p>在实现ServletContainerInitializer的时候，实现方法有两个参数<br>（1）参数一：Set&lt;Class&lt;?&gt;&gt; arg0：通过@HandlesTypes传递过来的类型</p>
<ul>
<li>启动类 @HandlesTypes<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//容器启动的时候会将@HandlesTypes指定的这个类型下面的子类（实现类、子接口等）全部传递过来</span></span><br><span class="line"><span class="meta">@HandlesTypes(value= &#123;HelloService.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServletContainerInitializer</span> <span class="keyword">implements</span> <span class="title class_">ServletContainerInitializer</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 应用启动的时候，会运行onStartup</span></span><br><span class="line"><span class="comment">	 * Set&lt;Class&lt;?&gt;&gt; arg0：通过<span class="doctag">@HandlesTypes</span>传递过来的类型</span></span><br><span class="line"><span class="comment">	 * ServletContext arg1：当前web应用的ServletContext对象，每一个web应用都会对应一个ServletContext</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; arg0, ServletContext arg1)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">for</span>(Class&lt;?&gt; clases:arg0) &#123;</span><br><span class="line">			System.out.println(<span class="string">&quot;传递的类型:&quot;</span>+ clases);	</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>javax.servlet.ServletContainerInitializer<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.zhy.servlet.MyServletContainerInitializer</span><br></pre></td></tr></table></figure></li>
<li>业务类<br>抽象类<br>&#x2F;Servlet3&#x2F;src&#x2F;com&#x2F;zhy&#x2F;service&#x2F;AbstractHelloService.java<br>接口<br>&#x2F;Servlet3&#x2F;src&#x2F;com&#x2F;zhy&#x2F;service&#x2F;HelloService.java<br>接口<br>&#x2F;Servlet3&#x2F;src&#x2F;com&#x2F;zhy&#x2F;service&#x2F;HelloServiceExt.java<br>实现类<br>&#x2F;Servlet3&#x2F;src&#x2F;com&#x2F;zhy&#x2F;service&#x2F;HelloServiceImpl.java</li>
</ul>
<p>启动服务<br><img src="/zhangyangibm/spring/0096.png" alt="servLet" title="servLet"></p>
<p>（2）参数二：ServletContext arg1,作用：当前web应用的ServletContext对象，每一个web应用都会对应一个ServletContext<br>使用ServletContext注册web组件，<strong>这个里边包含者三大组件，分别是：Servlet&#x2F;Filter&#x2F;Listener</strong><br>使用编码的方式，在项目code启动的时候给Servlet里边添加组件，添加前提就是在项目启动的时候：注册组件的方式<br>ServletContainerInitializer和ServletContextListener</p>
<p>实现：<br>创建一个Servlet</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(&quot;/tomcat&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		resp.getWriter().write(<span class="string">&quot;Tomcat&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建一个Filter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.out.println(<span class="string">&quot;Filter...destroy&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest arg0, ServletResponse arg1, FilterChain arg2)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;doFilter...init&quot;</span>);</span><br><span class="line">		arg2.doFilter(arg0, arg1);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig arg0)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Filter...init&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建一个Listener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserListener</span> <span class="keyword">implements</span> <span class="title class_">ServletContextListener</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextDestroyed</span><span class="params">(ServletContextEvent arg0)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.out.println(<span class="string">&quot;Listener....destroyed&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextInitialized</span><span class="params">(ServletContextEvent arg0)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.out.println(<span class="string">&quot;Listener....Initialized&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完善注册组件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//容器启动的时候会将@HandlesTypes指定的这个类型下面的子类（实现类、子接口等）全部传递过来</span></span><br><span class="line"><span class="meta">@HandlesTypes(value= &#123;HelloService.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServletContainerInitializer</span> <span class="keyword">implements</span> <span class="title class_">ServletContainerInitializer</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 应用启动的时候，会运行onStartup</span></span><br><span class="line"><span class="comment">	 * Set&lt;Class&lt;?&gt;&gt; arg0：通过<span class="doctag">@HandlesTypes</span>传递过来的类型</span></span><br><span class="line"><span class="comment">	 * ServletContext arg1：当前web应用的ServletContext对象，每一个web应用都会对应一个ServletContext</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; arg0, ServletContext arg1)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">for</span>(Class&lt;?&gt; clases:arg0) &#123;</span><br><span class="line">			System.out.println(<span class="string">&quot;传递的类型:&quot;</span>+ clases);	</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//注册组件</span></span><br><span class="line">		<span class="comment">//注册servlet</span></span><br><span class="line">		ServletRegistration.<span class="type">Dynamic</span> <span class="variable">servlet</span> <span class="operator">=</span> arg1.addServlet(<span class="string">&quot;UserServlet&quot;</span>, <span class="keyword">new</span> <span class="title class_">UserServlet</span>());</span><br><span class="line">		<span class="comment">//配置Servlet信息</span></span><br><span class="line">		servlet.addMapping(<span class="string">&quot;/user&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//注册Listener</span></span><br><span class="line">		arg1.addListener(UserListener.class);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//注册Filter</span></span><br><span class="line">		FilterRegistration.<span class="type">Dynamic</span> <span class="variable">filter</span> <span class="operator">=</span>arg1.addFilter(<span class="string">&quot;userfilter&quot;</span>, UserFilter.class);</span><br><span class="line">		filter.addMappingForUrlPatterns(EnumSet.of(DispatcherType.REQUEST), <span class="literal">true</span>,<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动<br><img src="/zhangyangibm/spring/0097.png" alt="servLet" title="servLet"><br>访问<br><img src="/zhangyangibm/spring/0098.png" alt="servLet" title="servLet"><br>停止<br><img src="/zhangyangibm/spring/0099.png" alt="servLet" title="servLet"><br><img src="/zhangyangibm/spring/0100.png" alt="servLet" title="servLet"></p>
<h4 id="2-2-整合SpringMVC"><a href="#2-2-整合SpringMVC" class="headerlink" title="2.2 整合SpringMVC"></a>2.2 整合SpringMVC</h4><p>整合SpringMVC主要借助注解，首先需要配置pom，spring-webmvc、javax.servlet-api</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zhy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringMvcAt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-webmvc --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">&lt;!-- https://mvnrepository.com/artifact/javax.servlet/javax.servlet-api --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-war-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">failOnMissingWebXml</span>&gt;</span>false<span class="tag">&lt;/<span class="name">failOnMissingWebXml</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置完成之后，查看Maven Dependencies，查看SpringWeb有一个文件夹META-INF&#x2F;service&#x2F;javax.servlet.ServletContainerInitializer<br><img src="/zhangyangibm/spring/0101.png" alt="servLet" title="servLet"><br>1、当web容器启动时，会扫描每个Jar包下的META-INF&#x2F;service&#x2F;javax.servlet.ServletContainerInitializer，内部配置内容：<br><strong>org.springframework.web.SpringServletContainerInitializer</strong><br><img src="/zhangyangibm/spring/0102.png" alt="servLet" title="servLet"><br><img src="/zhangyangibm/spring/0103.png" alt="servLet" title="servLet"><br>2、于此同时加载这个文件的指定的启动类，这个文件下指定的是SpringServletContainerInitializer，<br>3、Spring一启动就会加载WebApplicationInitializer接口下的所有组件；<br>4、并且为WebApplicationInitializer组件创建对象（前提是这些接口不是接口不是抽象类）<br>➡️ AbstractContestLoaderInitializer：创建根容器<br>➡️ AbstractDispatcherServletInitializer：创建一个web的IOC容器<br>  将创建的DispatcherServlet添加到ServletContext中，<br>➡️ AbstractAnnotationConfigDispatcherServletInitializer：注解方式配置的DispatcherServlet初始化器<br>  创建根容器<br>  创建Web的IOC容器</p>
<p>总结：<br>一注解的方式实现SpringMvc：继承AbstractAnnotationConfigDispatcherServletInitializer；<br>实现抽象方法指定的DispatcherServlet信息</p>
<p>根据上边的理论代码实现：<br>创建一个类MyWebApplicationInitializer实现AbstractAnnotationConfigDispatcherServletInitializer<br>在web容器启动的时候创建对象，调用方法来初始化容器以及前端控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyWebApplicationInitializer</span> <span class="keyword">extends</span> <span class="title class_">AbstractAnnotationConfigDispatcherServletInitializer</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取跟容器的配置类，也就是Spring的配置文件，父容器</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取web容器的配置类，SpringMvc配置文件 子容器</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取Servlet的映射信息</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> String[] getServletMappings() &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;/&quot;</span>&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类1:RootConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//扫描com.zhy，排除注解是Controller容器</span></span><br><span class="line"><span class="meta">@ComponentScan(value=&quot;com.zhy&quot;,excludeFilters = &#123;</span></span><br><span class="line"><span class="meta">		@Filter(type = FilterType.ANNOTATION,classes = &#123;Controller.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RootConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置类2:AppConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//扫描com.zhy，只扫描Controller容器</span></span><br><span class="line"><span class="comment">//useDefaultFilters = false 禁用默认的规则</span></span><br><span class="line"><span class="meta">@ComponentScan(value=&quot;com.zhy&quot;,includeFilters  = &#123;</span></span><br><span class="line"><span class="meta">		@Filter(type = FilterType.ANNOTATION,classes = &#123;Controller.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;,useDefaultFilters = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Controller类：HelloController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> HelloService helloController;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@ResponseBody</span></span><br><span class="line">	<span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">helli</span><span class="params">()</span> &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> helloController.sayHello(<span class="string">&quot;Tomcat&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Service类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloService</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;Hello....&quot;</span>+name;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完善MyWebApplicationInitializer：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyWebApplicationInitializer</span> <span class="keyword">extends</span> <span class="title class_">AbstractAnnotationConfigDispatcherServletInitializer</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;RootConfig.class&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[]&#123;AppConfig.class&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> String[] getServletMappings() &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;/&quot;</span>&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动服务可以访问hello</p>
<h4 id="2-3-定制SpringMVC"><a href="#2-3-定制SpringMVC" class="headerlink" title="2.3 定制SpringMVC"></a>2.3 定制SpringMVC</h4><p>1、注解 <strong>@EnableWebMvc</strong> 开启SpringMvc的定制功能，相当于之前xml中的”<a href="mvc:annotation-driven">mvc:annotation-driven</a>“<br>2、配置组件：试图解析器，静态资源映射，资源解析器等，实现方式实现WebMvcConfigurer接口<br><img src="/zhangyangibm/spring/0104.png" alt="servLet" title="servLet"><br>WebMvcConfigurer接口中有很多的方法，或发现内部的方法全部都是<strong>default</strong>修饰的，如果需要什么方法可以直接复写其中的方法</p>
<h4 id="2-4-异步请求"><a href="#2-4-异步请求" class="headerlink" title="2.4 异步请求"></a>2.4 异步请求</h4><p>当请求中假设有一个方法耗时3秒：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloService</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;Hello....&quot;</span>+name;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//3秒</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">		Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在传统的方式中，当请求到达时主线程相会请回对现对请求进行相应处理，如果一个方法的占用时间很长，主线程就得不到释放，此时当下一个请求到达时就会形成线程的拥堵。</p>
<p>在Servlet3.0中提供了一个注解，来解决这种问题。<br>1、支持异步处理：首先告诉servlet支持异步请求 <strong>@WebServlet(value &#x3D; “async”,asyncSupported &#x3D; true)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(value = &quot;async&quot;,asyncSupported = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloAsyncServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">		<span class="built_in">super</span>.doGet(req, resp);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">		Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/zhangyangibm/spring/0105.png" alt="servLet" title="servLet"><br>2、开启异步处理:</p>
<p>&#96;&#96;&#96;java<br>@WebServlet(value &#x3D; “&#x2F;async”, asyncSupported &#x3D; true)<br>public class HelloAsyncServlet extends HttpServlet {</p>
<pre><code>@Override
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123;
    // 开启异步处理
     AsyncContext asyncContext = req.startAsync();
    // 对异步处理进行设置
    asyncContext.start(new Runnable() &#123;

        public void run() &#123;
            // TODO Auto-generated method stub
            try &#123;
                sayHello();
                
            &#125; catch (Exception e) &#123;
                // TODO Auto-generated catch block
                e.printStackTrace();
            &#125;
        &#125;
        
    &#125;);
    //获取异步上下文
    asyncContext.complete();
    //获取相应
    asyncContext = req.getAsyncContext();

&#125;

public void sayHello() throws Exception &#123;
    Thread.sleep(3000);
&#125;
</code></pre>
<p>}</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">捕猹少年</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://gitee.com/zhangyangibm/zhangyangibm.git/2020/12/10/%E6%B5%85%E8%B0%88Spring/">https://gitee.com/zhangyangibm/zhangyangibm.git/2020/12/10/%E6%B5%85%E8%B0%88Spring/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://gitee.com/zhangyangibm/zhangyangibm.git" target="_blank">Gordo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/zhangyangibm/tags/java/">java</a><a class="post-meta__tags" href="/zhangyangibm/tags/spring/">spring</a><a class="post-meta__tags" href="/zhangyangibm/tags/%E5%AE%B9%E5%99%A8/">容器</a></div><div class="post_share"><div class="social-share" data-image="/zhangyangibm/img/spring.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/zhangyangibm/img/wechat.png" target="_blank"><img class="post-qr-code-img" src="/zhangyangibm/img/wechat.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/zhangyangibm/img/zhifubao.png" target="_blank"><img class="post-qr-code-img" src="/zhangyangibm/img/zhifubao.png" alt="zhifubao"/></a><div class="post-qr-code-desc">zhifubao</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/zhangyangibm/2020/12/10/Hadoop%E9%9B%86%E7%BE%A4/"><img class="prev-cover" src="/zhangyangibm/img/hadoop.png" onerror="onerror=null;src='/zhangyangibm/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Hadoop集群</div></div></a></div><div class="next-post pull-right"><a href="/zhangyangibm/2020/07/24/redis%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"><img class="next-cover" src="/zhangyangibm/img/redis.png" onerror="onerror=null;src='/zhangyangibm/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">redis集群</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/zhangyangibm/2021/03/01/%E6%B5%85%E8%B0%88Swagger/" title="浅谈Swagger"><img class="cover" src="/zhangyangibm/img/swagger.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-01</div><div class="title">浅谈Swagger</div></div></a></div><div><a href="/zhangyangibm/2019/12/26/%E6%B5%85%E8%B0%88springboot/" title="浅谈Springboot"><img class="cover" src="/zhangyangibm/img/Springboot.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-12-26</div><div class="title">浅谈Springboot</div></div></a></div><div><a href="/zhangyangibm/2019/11/26/%E9%9B%86%E5%90%88LinkedList&Map/" title="集合LinkedList&Map"><img class="cover" src="/zhangyangibm/img/collection.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-11-26</div><div class="title">集合LinkedList&Map</div></div></a></div><div><a href="/zhangyangibm/2020/07/23/webservice/" title="webservice"><img class="cover" src="/zhangyangibm/img/webservice.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-23</div><div class="title">webservice</div></div></a></div><div><a href="/zhangyangibm/2020/01/01/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/" title="多线程与高并发"><img class="cover" src="/zhangyangibm/img/thread.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-01-01</div><div class="title">多线程与高并发</div></div></a></div><div><a href="/zhangyangibm/2020/03/12/%E4%BA%86%E8%A7%A3springboot/" title="了解springboot"><img class="cover" src="/zhangyangibm/img/springboot_1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-12</div><div class="title">了解springboot</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/zhangyangibm/img/header.jpg" onerror="this.onerror=null;this.src='/zhangyangibm/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">捕猹少年</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/zhangyangibm/archives/"><div class="headline">文章</div><div class="length-num">14</div></a></div><div class="card-info-data-item"><a href="/zhangyangibm/tags/"><div class="headline">标签</div><div class="length-num">30</div></a></div><div class="card-info-data-item"><a href="/zhangyangibm/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div><a id="card-info-btn" href="https://gitee.com/zhangyangibm/zhangyangibm"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:123456789gordo@sina.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">大家好，欢迎来到我的频道，<br>新频道从2022年正式Github迁移至Gitee，感谢您一如既往的关注和支持！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81IOC%E5%AE%B9%E5%99%A8"><span class="toc-number">2.</span> <span class="toc-text">1、IOC容器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1%E3%80%81%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.1.</span> <span class="toc-text">1.1、创建对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2%E3%80%81%E5%8C%85%E6%89%AB%E6%8F%8F"><span class="toc-number">2.2.</span> <span class="toc-text">1.2、包扫描</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1-%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.1.</span> <span class="toc-text">1.2.1 实现方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2-%E8%BF%87%E6%BB%A4"><span class="toc-number">2.2.2.</span> <span class="toc-text">1.2.2 过滤</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-%E5%8D%95%E5%AE%9E%E4%BE%8B%E5%92%8C%E5%A4%9A%E5%AE%9E%E4%BE%8B"><span class="toc-number">2.3.</span> <span class="toc-text">1.3 单实例和多实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-%E6%87%92%E5%8A%A0%E8%BD%BD"><span class="toc-number">2.4.</span> <span class="toc-text">1.4 懒加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD%E6%B3%A8%E5%86%8Cbean-Conditional%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.5.</span> <span class="toc-text">1.5 使用条件判断注册bean @Conditional注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-%E5%AF%BC%E5%85%A5%E7%BB%84%E4%BB%B6%E7%9A%84%E4%B8%89%E7%A7%8D%E7%94%A8%E6%B3%95"><span class="toc-number">2.6.</span> <span class="toc-text">1.6 导入组件的三种用法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-FactoryBean%EF%BC%88%E5%B7%A5%E5%8E%82Bean%EF%BC%89"><span class="toc-number">2.7.</span> <span class="toc-text">1.7 FactoryBean（工厂Bean）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-8-Bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">2.8.</span> <span class="toc-text">1.8 Bean的生命周期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-9-%E5%B1%9E%E6%80%A7%E8%B5%8B%E5%80%BC"><span class="toc-number">2.9.</span> <span class="toc-text">1.9 属性赋值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-0-%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D"><span class="toc-number">2.10.</span> <span class="toc-text">2.0 自动装配</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-1"><span class="toc-number">3.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81AOP"><span class="toc-number">4.</span> <span class="toc-text">1、AOP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1%E3%80%81%E9%9D%A2%E5%90%91%E5%88%87%E9%9D%A2%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B"><span class="toc-number">4.1.</span> <span class="toc-text">1.1、面向切面实现流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2%E3%80%81AOP%E9%9D%A2%E5%90%91%E5%88%87%E9%9D%A2%E5%8E%9F%E7%90%86"><span class="toc-number">4.2.</span> <span class="toc-text">1.2、AOP面向切面原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1%E3%80%81-EnableAspectJAutoProxy%E5%AE%9E%E7%8E%B0%E7%9B%AE%E7%9A%84"><span class="toc-number">4.2.1.</span> <span class="toc-text">1.2.1、@EnableAspectJAutoProxy实现目的</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2%E3%80%81%E5%85%B3%E4%BA%8EAnnotationAwareAspectJAutoProxyCreator"><span class="toc-number">4.2.2.</span> <span class="toc-text">1.2.2、关于AnnotationAwareAspectJAutoProxyCreator</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3%E3%80%81AOP%E9%9D%A2%E5%90%91%E5%88%87%E9%9D%A2%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-number">4.3.</span> <span class="toc-text">1.2.3、AOP面向切面总结：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E4%BA%8B%E5%8A%A1%EF%BC%88Transaction%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">2、事务（Transaction）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1%E3%80%81%E7%8E%AF%E5%A2%83"><span class="toc-number">5.1.</span> <span class="toc-text">2.1、环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2%E3%80%81-Transactional%E6%B3%A8%E8%A7%A3"><span class="toc-number">5.2.</span> <span class="toc-text">2.2、@Transactional注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3%E3%80%81-EnableTransactionManagement%E6%B3%A8%E8%A7%A3"><span class="toc-number">5.3.</span> <span class="toc-text">2.3、@EnableTransactionManagement注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3%E3%80%81%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0%E6%80%BB%E7%BB%93"><span class="toc-number">5.4.</span> <span class="toc-text">2.3、功能实现总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4%E3%80%81%E4%BA%8B%E5%8A%A1%E5%A3%B0%E6%98%8E%E7%9A%84%E5%88%86%E6%9E%90"><span class="toc-number">5.5.</span> <span class="toc-text">2.4、事务声明的分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-2"><span class="toc-number">6.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Spring%E7%9A%84%E6%89%A9%E5%B1%95%E5%8E%9F%E7%90%86"><span class="toc-number">7.</span> <span class="toc-text">1、Spring的扩展原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1%E3%80%81BeanFactoryPostProcessor%E6%8E%A5%E5%8F%A3"><span class="toc-number">7.1.</span> <span class="toc-text">1.1、BeanFactoryPostProcessor接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2%E3%80%81BeanDefinitionRegistryPostProcessor"><span class="toc-number">7.2.</span> <span class="toc-text">1.2、BeanDefinitionRegistryPostProcessor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3%E3%80%81ApplicationListener-%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">7.3.</span> <span class="toc-text">1.3、ApplicationListener 监听器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4%E3%80%81Spring%E6%BA%90%E7%A0%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B"><span class="toc-number">7.4.</span> <span class="toc-text">1.4、Spring源码的实现流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81SpringWeb"><span class="toc-number">8.</span> <span class="toc-text">2、SpringWeb</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-Shared-libraries-x2F-runtimes-pluggability"><span class="toc-number">8.1.</span> <span class="toc-text">2.1 Shared libraries &#x2F; runtimes pluggability</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%95%B4%E5%90%88SpringMVC"><span class="toc-number">8.2.</span> <span class="toc-text">2.2 整合SpringMVC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E5%AE%9A%E5%88%B6SpringMVC"><span class="toc-number">8.3.</span> <span class="toc-text">2.3 定制SpringMVC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82"><span class="toc-number">8.4.</span> <span class="toc-text">2.4 异步请求</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/zhangyangibm/2021/12/24/Docker%20for%20Linux/" title="Docker for Liunx"><img src="/zhangyangibm/img/docker.png" onerror="this.onerror=null;this.src='/zhangyangibm/img/404.jpg'" alt="Docker for Liunx"/></a><div class="content"><a class="title" href="/zhangyangibm/2021/12/24/Docker%20for%20Linux/" title="Docker for Liunx">Docker for Liunx</a><time datetime="2021-12-24T14:49:47.000Z" title="发表于 2021-12-24 22:49:47">2021-12-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/zhangyangibm/2021/05/03/mysql%E6%95%B0%E6%8D%AE%E5%BA%93/" title="MySql"><img src="/zhangyangibm/img/mysql.png" onerror="this.onerror=null;this.src='/zhangyangibm/img/404.jpg'" alt="MySql"/></a><div class="content"><a class="title" href="/zhangyangibm/2021/05/03/mysql%E6%95%B0%E6%8D%AE%E5%BA%93/" title="MySql">MySql</a><time datetime="2021-05-03T04:47:47.000Z" title="发表于 2021-05-03 12:47:47">2021-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/zhangyangibm/2021/03/01/%E6%B5%85%E8%B0%88Swagger/" title="浅谈Swagger"><img src="/zhangyangibm/img/swagger.png" onerror="this.onerror=null;this.src='/zhangyangibm/img/404.jpg'" alt="浅谈Swagger"/></a><div class="content"><a class="title" href="/zhangyangibm/2021/03/01/%E6%B5%85%E8%B0%88Swagger/" title="浅谈Swagger">浅谈Swagger</a><time datetime="2021-03-01T14:47:47.000Z" title="发表于 2021-03-01 22:47:47">2021-03-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/zhangyangibm/2020/12/10/Hadoop%E9%9B%86%E7%BE%A4/" title="Hadoop集群"><img src="/zhangyangibm/img/hadoop.png" onerror="this.onerror=null;this.src='/zhangyangibm/img/404.jpg'" alt="Hadoop集群"/></a><div class="content"><a class="title" href="/zhangyangibm/2020/12/10/Hadoop%E9%9B%86%E7%BE%A4/" title="Hadoop集群">Hadoop集群</a><time datetime="2020-12-10T14:47:47.000Z" title="发表于 2020-12-10 22:47:47">2020-12-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/zhangyangibm/2020/12/10/%E6%B5%85%E8%B0%88Spring/" title="浅谈spring"><img src="/zhangyangibm/img/spring.png" onerror="this.onerror=null;this.src='/zhangyangibm/img/404.jpg'" alt="浅谈spring"/></a><div class="content"><a class="title" href="/zhangyangibm/2020/12/10/%E6%B5%85%E8%B0%88Spring/" title="浅谈spring">浅谈spring</a><time datetime="2020-12-10T14:47:47.000Z" title="发表于 2020-12-10 22:47:47">2020-12-10</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/zhangyangibm/img/top_img.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 捕猹少年</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to <a target="_blank" rel="noopener" href="https://zhangyangibm.gitee.io/">ZHY.Channel</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/zhangyangibm/js/utils.js"></script><script src="/zhangyangibm/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://gitee.com/zhangyangibm/zhangyangibm.git/2020/12/10/%E6%B5%85%E8%B0%88Spring/'
    this.page.identifier = '2020/12/10/浅谈Spring/'
    this.page.title = '浅谈spring'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Valine' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>